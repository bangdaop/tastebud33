<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Taste Buds</title>

    <style>
        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            font-family: system-ui;
            background: linear-gradient(180deg, #f3f6fb, #e9eef5)
        }

        .app {
            max-width: 720px;
            margin: auto;
            padding: 12px
        }

        .header img {
            width: 100%;
            border-radius: 14px;
            display: block
        }

        #surveyWrap {
            position: sticky;
            top: 0;
            background: #f3f6fb;
            padding: 8px 0;
            z-index: 20
        }

        #surveyBar {
            height: 6px;
            background: #d9dee6;
            border-radius: 6px;
            overflow: hidden
        }

        #surveyBarInner {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #0d3b66, #3fa9f5);
            transition: .3s
        }

        #loadWrap {
            text-align: center;
            margin: 12px 0
        }

        #loadTrack {
            height: 6px;
            background: #ddd;
            border-radius: 6px;
            overflow: hidden
        }

        #loadBar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ff7a00, #ffb347)
        }

        #loadText {
            font-size: 12px;
            margin-top: 6px;
            opacity: .7
        }

        .field {
            background: white;
            padding: 14px;
            border-radius: 14px;
            margin-bottom: 14px;
            box-shadow: 0 8px 18px rgba(0, 0, 0, .06)
        }

        label {
            font-weight: 600;
            display: block;
            margin-bottom: 8px
        }

        input,
        select {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #d7dce4;
            background: #fafbfc;
            font-size: 15px
        }

        .badge {
            margin-top: 8px;
            font-size: 15px;
            font-weight: 600;
            color: #0d3b66
        }

        #submitBtn {
            margin-top: 16px;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            background: #ff7a00;
            color: white;
            font-size: 16px;
            opacity: .4
        }

        #submitBtn:not(:disabled) {
            opacity: 1
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            padding: 6px 0;
            border-bottom: 1px dashed #ddd
        }

        /* MATRIX */
        #matrixOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999
        }

        #matrixText {
            color: #00ff66;
            font-family: monospace;
            font-size: 20px;
            white-space: pre-wrap
        }

        .statement {
            font-weight: bold;
            font-size: 16px;
        }
    </style>
</head>

<body>

    <div class="app">

        <div class="header">
            <img
                src="https://raw.githubusercontent.com/bangdaop/33cimg/9c0a0d694849c5fcc4fde282076fc70f0c46492f/33%20combo.PNG">
        </div>

        <div id="loadWrap">
            <div id="loadTrack">
                <div id="loadBar"></div>
            </div>
            <div id="loadText">Loading‚Ä¶</div>
        </div>

        <div id="surveyWrap" style="display:none">
            <div id="surveyBar">
                <div id="surveyBarInner"></div>
            </div>
        </div>

        <div id="formWrapper"></div>

        <button id="submitBtn" disabled>Finish</button>

        <div id="thankYou"></div>

    </div>

    <div id="matrixOverlay">
        <div id="matrixText"></div>
    </div>

    <script>
        const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzxp6xJwgKTXCO5jas3mg7fD3fBbH5-0MHPkYD3K55LNN2Z7Yli88cvWKv17OcxpvSU/exec"

        let sessionId = localStorage.getItem("tb_session_id")
        if (!sessionId) {
            sessionId = 's_' + Math.random().toString(36).slice(2, 12)
            localStorage.setItem("tb_session_id", sessionId)
        }

        const answers = {}
        let config = []
        let cityMap = {}
        let ageMap = {}

        const qs = s => document.querySelector(s)
        const el = (t, a = {}, ...c) => { const n = document.createElement(t); for (const k in a) n.setAttribute(k, a[k]); c.forEach(x => n.append(x)); return n }

        function autosave(k, v) {
            fetch(WEBAPP_URL, { method: 'POST', body: JSON.stringify({ sessionId, fieldName: k, fieldValue: v }) })
        }

        function updateProgress() {
            let d = 0
            const requiredFields = config.filter(f => f.type !== 'statement')
            requiredFields.forEach(f => answers[f.key] != null && answers[f.key] !== '' && d++)
            qs('#surveyBarInner').style.width = Math.round(d / requiredFields.length * 100) + '%'
            qs('#surveyWrap').style.display = 'block'
            qs('#submitBtn').disabled = d !== requiredFields.length
        }

        function scrollToNextField(currentBox) {
            let nextBox = currentBox.nextElementSibling;
            while (nextBox && !nextBox.classList.contains('field')) {
                nextBox = nextBox.nextElementSibling;
            }
            if (nextBox) {
                nextBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                // If no next field, scroll to submit button
                qs('#submitBtn').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        async function load() {
            qs('#loadBar').style.width = '40%'
            const r = await fetch(WEBAPP_URL)
            const j = await r.json()

            config = j.config.filter(x => x.key)

            // ---- BUILD AGE MAP ----
            ageMap = {}
                ; (j.ageTags || []).forEach(r => {
                    if (r.key && r.displayLabel) {
                        let cleanKey = r.key.replace(/[\u{1F000}-\u{1FFFF}]/gu, '').trim()
                        ageMap[cleanKey] = r.displayLabel.trim()
                    }
                })

            // ---- BUILD CITY ‚Üí STATE MAP ----
            cityMap = {}
            const cityMappings = j.cityMappings || [];
            if (Array.isArray(cityMappings)) {
                cityMappings.forEach(r => {
                    if (r.city && r.state) {
                        cityMap[r.city.trim()] = r.state.trim()
                    }
                })
            } else {
                const cityToState = j.cityMappings.cityToState || {};
                for (let city in cityToState) {
                    cityMap[city.trim()] = cityToState[city].trim()
                }
            }

            qs('#loadBar').style.width = '90%'
            build()

            setTimeout(() => qs('#loadWrap').style.display = 'none', 300)
        }

        function build() {
            const w = qs('#formWrapper')
            w.innerHTML = ''

            config.forEach(f => {
                const box = el('div', { class: 'field' })

                if (f.type === 'statement') {
                    box.append(el('p', { class: 'statement' }, f.label))
                } else {
                    box.append(el('label', {}, f.label))

                    if (f.type === 'select') {
                        const s = el('select')
                        s.append(el('option', { value: '', hidden: true }, ''))

                        f.options.split(/;|,/).forEach(o => s.append(el('option', { value: o.trim() }, o.trim())))

                        s.onchange = () => {
                            answers[f.key] = s.value
                            autosave(f.key, s.value)

                            box.querySelectorAll('.badge').forEach(b => b.remove())

                            if (f.key.toLowerCase().includes('city')) {
                                box.append(el('div', { class: 'badge' }, 'üìç ' + (cityMap[s.value] || '')))
                            }

                            if (f.key.toLowerCase().includes('age')) {
                                box.append(el('div', { class: 'badge' }, ageMap[s.value] || ''))
                            }

                            updateProgress()
                            scrollToNextField(box)
                        }

                        box.append(s)
                    }

                    else {
                        const i = el('input', { type: f.type })
                        i.onblur = () => {
                            answers[f.key] = i.value
                            autosave(f.key, i.value)
                            updateProgress()
                            scrollToNextField(box)
                        }
                        box.append(i)
                    }
                }

                w.append(box)
            })
        }

        qs('#submitBtn').onclick = async () => {
            const o = qs('#matrixOverlay')
            const t = qs('#matrixText')
            o.style.display = 'flex'

            const msg = "Submitting your choices to Head Chef CEO Elong Mask . . ."
            let i = 0
            t.textContent = ''

            const typer = setInterval(() => {
                t.textContent += msg[i++] || ''
                if (i > msg.length) clearInterval(typer)
            }, 40)

            await fetch(WEBAPP_URL, { method: 'POST', body: JSON.stringify({ sessionId, submitted: true, answers }) })

            qs('.app').style.display = 'none'
            o.style.display = 'none'

            let out = '<h3>Thank you guys!! See ya soon with Smoky Flavours üéâ‚ù§Ô∏è‚Äçüî•</h3>'
            Object.keys(answers).forEach(k => out += `<div class="summary-row"><b>${k}</b><span>${answers[k]}</span></div>`)
            document.body.innerHTML = out
        }

        load()
    </script>

</body>

</html>
