<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Taste Buds</title>

    <style>
        /* =====================
   iOS SPRING SYSTEM
===================== */
        :root {
            --spring-fast: cubic-bezier(.34, 1.56, .64, 1);
            --spring-soft: cubic-bezier(.25, 1.4, .5, 1);
        }

        /* =====================
   BASE
===================== */
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont;
            background: linear-gradient(180deg, #f3f6fb, #e9eef5);
        }

        .app {
            max-width: 720px;
            margin: auto;
            padding: 12px;
        }

        /* =====================
   HEADER IMAGE
===================== */
        .header img {
            width: 100%;
            border-radius: 14px;
            display: block;
        }

        /* =====================
   LOADER
===================== */
        #loadWrap {
            margin: 12px 0;
            text-align: center;
        }

        #loadTrack {
            height: 6px;
            background: #ddd;
            border-radius: 6px;
            overflow: hidden;
        }

        #loadBar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ff7a00, #ffb347);
            transition: width .5s var(--spring-soft);
        }

        #loadText {
            font-size: 12px;
            margin-top: 6px;
            opacity: .7;
        }

        /* =====================
   FLOATING PROGRESS
===================== */
        #surveyWrap {
            position: sticky;
            top: 0;
            z-index: 20;
            background: #f3f6fb;
            padding: 8px 0;
            display: none;
        }

        #surveyBar {
            height: 6px;
            background: #d9dee6;
            border-radius: 6px;
            overflow: hidden;
        }

        #surveyBarInner {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #0d3b66, #3fa9f5);
            transition: width .6s var(--spring-soft);
        }

        /* =====================
   QUESTION CARDS
===================== */
        .field {
            background: rgba(255, 255, 255, .85);
            backdrop-filter: blur(10px);
            padding: 14px;
            border-radius: 14px;
            margin-bottom: 14px;
            box-shadow: 0 8px 18px rgba(0, 0, 0, .06);
            opacity: 0;
            transform: translateY(14px);
            animation: cardIn .55s var(--spring-soft) forwards;
        }

        @keyframes cardIn {
            to {
                opacity: 1;
                transform: none
            }
        }

        label {
            font-weight: 600;
            display: block;
            margin-bottom: 8px;
        }

        /* Inputs unified size */
        input,
        select {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #d7dce4;
            background: #fafbfc;
            font-size: 15px;
            appearance: none;
        }

        /* Smooth select feel */
        select {
            transition: box-shadow .35s var(--spring-soft),
                transform .35s var(--spring-soft);
        }

        select:focus {
            outline: none;
            transform: scale(1.01);
            box-shadow: 0 0 0 3px rgba(63, 169, 245, .2);
        }

        input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(63, 169, 245, .2);
        }

        /* =====================
   BADGES (STATE / AGE)
===================== */
        .badge {
            margin-top: 10px;
            font-size: 15px;
            font-weight: 600;
            color: #0d3b66;
            display: flex;
            align-items: center;
            gap: 6px;
            animation: badgeIn .4s var(--spring-fast);
        }

        @keyframes badgeIn {
            from {
                opacity: 0;
                transform: scale(.9)
            }

            to {
                opacity: 1;
                transform: none
            }
        }

        /* =====================
   SUBMIT BUTTON
===================== */
        #submitBtn {
            margin-top: 16px;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            background: #ff7a00;
            color: white;
            font-size: 16px;
            opacity: .4;
            transition: opacity .4s var(--spring-soft),
                transform .25s var(--spring-soft);
        }

        #submitBtn:not(:disabled) {
            opacity: 1;
        }

        #submitBtn:active {
            transform: scale(.97);
        }

        /* =====================
   SUBMIT OVERLAY
===================== */
        #submitOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .45);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        #terminal {
            font-family: monospace;
            color: #00ff66;
            font-size: 14px;
        }

        /* =====================
   THANK YOU
===================== */
        .summary-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            padding: 6px 0;
            border-bottom: 1px dashed #ddd;
        }

        /* =====================
   MOBILE
===================== */
        @media(max-width:600px) {
            .app {
                padding: 8px
            }
        }
    </style>
</head>

<body>

    <div class="app">

        <div class="header">
            <img
                src="https://raw.githubusercontent.com/bangdaop/33cimg/9c0a0d694849c5fcc4fde282076fc70f0c46492f/33%20combo.PNG">
        </div>

        <div id="loadWrap">
            <div id="loadTrack">
                <div id="loadBar"></div>
            </div>
            <div id="loadText">Loading‚Ä¶</div>
        </div>

        <div id="surveyWrap">
            <div id="surveyBar">
                <div id="surveyBarInner"></div>
            </div>
        </div>

        <div id="formWrapper"></div>

        <button id="submitBtn" disabled>Finish</button>

        <div id="thankYou" style="display:none"></div>

    </div>

    <!-- SUBMIT OVERLAY -->
    <div id="submitOverlay">
        <div id="terminal"></div>
    </div>

    <script>
        const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwXlYjodsqdwXD1lpUObHRUxO-4g99cRvMU77rJ3YMi7ySHMHmiLM-hNceq5RvbCTUw/exec";

        let sessionId = localStorage.getItem("tb_session_id");
        if (!sessionId) {
            sessionId = 's_' + Math.random().toString(36).slice(2, 12);
            localStorage.setItem("tb_session_id", sessionId);
        }

        const answers = {};
        let configFields = [];
        let cityMap = {};
        let ageTags = {};

        const qs = x => document.querySelector(x);
        const el = (t, a = {}, ...c) => {
            const n = document.createElement(t);
            for (const k in a) n.setAttribute(k, a[k]);
            c.forEach(x => n.append(x));
            return n;
        };

        function setLoad(p) {
            qs('#loadBar').style.width = p + '%';
            qs('#loadText').innerText = 'Loading‚Ä¶ ' + p + '%';
        }

        function autosave(k, v) {
            fetch(WEBAPP_URL, { method: 'POST', body: JSON.stringify({ sessionId, fieldName: k, fieldValue: v }) });
        }

        function scrollNext(card) {
            setTimeout(() => {
                card.nextElementSibling?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 250);
        }

        function updateProgress() {
            let done = 0;
            configFields.forEach(f => {
                const v = answers[f.key];
                if (v !== undefined && v !== '') done++;
            });
            const pct = Math.round(done / configFields.length * 100);
            qs('#surveyBarInner').style.width = pct + '%';
            qs('#surveyWrap').style.display = 'block';
            qs('#submitBtn').disabled = done !== configFields.length;
        }

        async function loadConfig() {
            setLoad(20);
            const r = await fetch(WEBAPP_URL);
            setLoad(60);
            const j = await r.json();

            configFields = j.config || [];
            cityMap = j.cityMappings?.cityToState || {};
            (j.ageTags || []).forEach(a => ageTags[a.key] = a.displayLabel);

            setLoad(90);
            buildForm();
            setTimeout(() => qs('#loadWrap').style.display = 'none', 300);
        }

        function buildForm() {
            const w = qs('#formWrapper');
            w.innerHTML = '';

            configFields.forEach(f => {
                const box = el('div', { class: 'field' });
                box.append(el('label', {}, f.label));

                if (f.type === 'select') {
                    const s = el('select', { name: f.key });
                    s.append(el('option', { value: '', hidden: true }, ''));
                    f.options.split(/;|,/).forEach(o => {
                        s.append(el('option', { value: o.trim() }, o.trim()));
                    });
                    s.onchange = () => {
                        answers[f.key] = s.value;
                        autosave(f.key, s.value);

                        if (f.key === 'City') {
                            box.querySelector('.badge')?.remove();
                            box.append(el('div', { class: 'badge' }, 'üìç ' + (cityMap[s.value] || '')));
                        }

                        if (f.key === 'Age') {
                            box.querySelector('.badge')?.remove();
                            box.append(el('div', { class: 'badge' }, ageTags[s.value] || ''));
                        }

                        updateProgress();
                        scrollNext(box);
                    };
                    box.append(s);
                }

                else if (f.type === 'text' || f.type === 'number') {
                    const i = el('input', { type: f.type });
                    i.onblur = () => {
                        answers[f.key] = i.value;
                        autosave(f.key, i.value);
                        updateProgress();
                        scrollNext(box);
                    };
                    box.append(i);
                }

                else if (f.type === 'radio') {
                    f.options.split(/;|,/).forEach(o => {
                        const v = o.trim();
                        const r = el('input', { type: 'radio', name: f.key, value: v });
                        r.onchange = () => {
                            answers[f.key] = v;
                            autosave(f.key, v);
                            updateProgress();
                            scrollNext(box);
                        };
                        box.append(el('label', {}, r, ' ' + v));
                    });
                }

                w.append(box);
            });
        }

        qs('#submitBtn').onclick = async () => {
            qs('#submitOverlay').style.display = 'flex';

            const msg = "Submitting your choices to Head Chef CEO Elong Mask . . .";
            let i = 0;
            const t = qs('#terminal');
            t.innerText = '';
            const typer = setInterval(() => {
                t.innerText += msg[i++] || '';
                if (i >= msg.length) clearInterval(typer);
            }, 40);

            await fetch(WEBAPP_URL, { method: 'POST', body: JSON.stringify({ sessionId, submitted: true, answers }) });

            setTimeout(() => {
                qs('#submitOverlay').style.display = 'none';
                qs('#formWrapper').style.display = 'none';
                qs('#submitBtn').style.display = 'none';
                qs('#surveyWrap').style.display = 'none';

                let out = '<h3>Thank you guys!! See ya soon with Smoky Flavours üéâ‚ù§Ô∏è‚Äçüî•</h3>';
                Object.keys(answers).forEach(k => {
                    out += `<div class="summary-row"><b>${k}</b><span>${answers[k]}</span></div>`;
                });
                qs('#thankYou').innerHTML = out;
                qs('#thankYou').style.display = 'block';
            }, 1200);
        };

        loadConfig();
    </script>

</body>

</html>
