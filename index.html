<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Taste Buds Choices</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#f6f8fa; --bg2:#eef2f5; --card:#ffffff; --accent:#ff7a00; --accent-2:#0d3b66;
    --muted:#6b7280; --radius:12px; --shadow:0 14px 40px rgba(13,59,102,0.08); --gap:14px;
  }
  html,body{height:100%;margin:0;font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#111827;background:linear-gradient(180deg,var(--bg1),var(--bg2));-webkit-font-smoothing:antialiased}
  .app{max-width:980px;margin:20px auto;border-radius:16px;overflow:hidden;box-shadow:var(--shadow);background:linear-gradient(180deg,#fff,#fbfbff);border:1px solid rgba(13,59,102,0.04)}
  header{position:relative;padding:22px 20px 28px;text-align:center;color:#fff;background-color: rgba(13,59,102,0.06);overflow:visible;min-height:120px}
  header .bg-img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:0;opacity:0.98}
  header .overlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(13,59,102,0.18),rgba(13,59,102,0.12));z-index:1}
  header .content{position:relative;z-index:2}
  h1 {
    position: relative;
    display: inline-block;
    margin: 0;
    font-size: 30px;
    color: #ffea00;
    font-weight: 800;
    -webkit-font-smoothing: antialiased;
    padding: 6px 14px;
    border-radius: 10px;
    text-shadow:
      0 0 8px #ff2828,
      0 0 16px #ff2828,
      0 0 24px #ff4444,
      0 0 32px #ff2828,
      0 0 40px rgba(255,68,68,0.60),
      0 0 60px rgba(255,40,40,0.40),
      0 4px 16px rgba(0,0,0,0.30);
  }
  .tagline {
    position: relative;
    display: inline-block;
    margin-top: 8px;
    color: #ffea66;
    font-size: 20px;
    line-height: 1.3;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 8px;
    text-shadow:
      0 0 6px #ff2828,
      0 0 12px #ff2828,
      0 0 18px #ff4444,
      0 0 24px rgba(255,40,40,0.50),
      0 0 32px rgba(255,68,68,0.40);
  }
  main{display:flex;gap:var(--gap);padding:16px}
  .left{flex:1;min-width:0}
  .card{background:var(--card);border-radius:12px;padding:12px;border:1px solid rgba(13,59,102,0.03)}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .field{display:flex;flex-direction:column;gap:8px;margin-bottom:6px;padding:6px;border-radius:10px}
  label{font-weight:600;color:#0f172a;font-size:13px}
  .control-bg{background:linear-gradient(180deg, rgba(238,242,245,0.9), rgba(246,248,250,0.95));border-radius:10px;padding:6px}
  select,input,textarea{font-size:15px;padding:12px;border-radius:10px;border:1px solid rgba(13,59,102,0.06);background:transparent;color:#0f172a;width:100%;box-sizing:border-box}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  .summary-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:linear-gradient(180deg,#fff,#fbfbff);border:1px solid rgba(13,59,102,0.03);font-size:13px}
  .controls{display:flex;gap:12px;justify-content:flex-end;margin-top:14px}
  .btn-primary{background:linear-gradient(180deg,var(--accent),#d95b00);color:white;border:none;padding:12px 18px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn-secondary{background:transparent;border:1px solid #e6eef6;padding:10px 14px;border-radius:10px;cursor:pointer}
  .small-muted{font-size:13px;color:var(--muted)}
  .sidebar{width:320px;display:flex;flex-direction:column;gap:12px}
  @media (max-width:820px){main{flex-direction:column;padding:12px}.form-grid{grid-template-columns:1fr}.sidebar{display:none}.controls{display:none}.app{margin:8px}header{padding:18px}}
  #progressWrap {
    position: relative;
    height: 6px;
    background: rgba(207,233,255,0.4);
    border-radius: 6px;
    overflow: hidden;
    margin: 8px 0 6px;
  }
  #progressBar {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg,#cfe9ff,#9fd6ff);
    box-shadow: 0 6px 18px rgba(31,120,255,0.08);
    transition: width 300ms ease;
  }
</style>
</head>
<body>
  <div class="app" role="application" aria-labelledby="appTitle">
    <header>
      <img class="bg-img" id="headerBg" alt="header background" src="header.jpg" onerror="this.style.display='none';document.querySelector('header').style.background='linear-gradient(180deg,#0d3b66,#1f6fbf)';" />
      <div class="overlay"></div>
      <div class="content">
        <h1 id="appTitle">Taste Buds Choices</h1>
        <div class="tagline">Pick your combo — we’ll drop it near you. Lock your picks and we’ll deliver vibes.</div>
      </div>
    </header>

    <main>
      <div class="left">
        <div id="formArea" class="card" aria-live="polite">
          <div id="progressWrap">
            <div id="progressBar"></div>
          </div>
          <div id="formWrapper" style="margin-top:12px;"></div>
        </div>

        <div class="controls" style="margin-top:12px">
          <button id="resetBtn" class="btn-secondary" type="button">Reset</button>
          <button id="submitBtn" class="btn-primary" type="button">Finish</button>
        </div>

        <div id="message" style="margin-top:12px"></div>
      </div>

            <aside class="sidebar">
        <div class="card">
          <div style="font-weight:700;margin-bottom:6px">Your quick summary</div>
          <div class="small-muted" id="sessionIdDisplay" style="margin-bottom:8px"></div>
          <div id="summaryList" style="display:flex;flex-direction:column;gap:8px"></div>
        </div>
      </aside>
    </main>
  </div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwXlYjodsqdwXD1lpUObHRUxO-4g99cRvMU77rJ3YMi7ySHMHmiLM-hNceq5RvbCTUw/exec";

/* --- Session setup --- */
let sessionId = localStorage.getItem("tb_session_id");
if (!sessionId) {
  sessionId = Math.random().toString(36).substring(2,10);
  localStorage.setItem("tb_session_id", sessionId);
}
document.getElementById("sessionIdDisplay").textContent = "Session: " + sessionId;

/* --- State --- */
let answers = {};
let configFields = [];

/* --- Helpers --- */
function el(tag, attrs={}, ...children) {
  const node = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)) {
    if (k==="class") node.className=v;
    else if (k==="style") node.style.cssText=v;
    else node.setAttribute(k,v);
  }
  for (const c of children) {
    if (typeof c==="string") node.appendChild(document.createTextNode(c));
    else if (c) node.appendChild(c);
  }
  return node;
}
function qs(sel){return document.querySelector(sel);}

/* --- Autosave --- */
function postAutosaveDebounced(key,val){
  clearTimeout(postAutosaveDebounced.t);
  postAutosaveDebounced.t=setTimeout(()=>postAutosave(key,val),400);
}
function postAutosave(key,val){
  fetch(WEBAPP_URL,{
    method:"POST",
    body:JSON.stringify({sessionId,autosave:true,key,val}),
    headers:{"Content-Type":"application/json"}
  });
}

/* --- Build form --- */
function buildFormFromConfig(config){
  configFields=config;
  const wrap=qs("#formWrapper");
  wrap.innerHTML="";
  const grid=el("div",{class:"form-grid"});
  wrap.appendChild(grid);

  config.forEach(field=>{
    const f=el("div",{class:"field"});
    const lab=el("label",{},field.label);
    f.appendChild(lab);
    const controlBg=el("div",{class:"control-bg"});
    f.appendChild(controlBg);

    if(field.type==="select"){
      const sel=el("select",{name:field.key});
      (field.options||"").split(",").forEach(opt=>{
        if(opt) sel.appendChild(el("option",{value:opt},opt));
      });
      sel.addEventListener("change",()=>{
        answers[field.key]=sel.value;
        postAutosaveDebounced(field.key,sel.value);
        updateSummaryUI();
      });
      controlBg.appendChild(sel);
    }
    else if(field.type==="radio"){
      (field.options||"").split(",").forEach(opt=>{
        if(!opt) return;
        const r=el("label",{},
          el("input",{type:"radio",name:field.key,value:opt}),
          " "+opt
        );
        r.querySelector("input").addEventListener("change",()=>{
          answers[field.key]=opt;
          postAutosaveDebounced(field.key,opt);
          updateSummaryUI();
        });
        controlBg.appendChild(r);
      });
    }
    else if(field.type==="checkbox"){
      (field.options||"").split(",").forEach(opt=>{
        if(!opt) return;
        const c=el("label",{},
          el("input",{type:"checkbox",name:field.key,value:opt}),
          " "+opt
        );
        c.querySelector("input").addEventListener("change",()=>{
          const vals=[...controlBg.querySelectorAll("input:checked")].map(i=>i.value);
          answers[field.key]=vals;
          postAutosaveDebounced(field.key,vals);
          updateSummaryUI();
        });
        controlBg.appendChild(c);
      });
    }
    else if(field.type==="textarea"){
      const ta=el("textarea",{name:field.key});
      ta.addEventListener("change",()=>{
        answers[field.key]=ta.value;
        postAutosaveDebounced(field.key,ta.value);
        updateSummaryUI();
      });
      controlBg.appendChild(ta);
    }
    else if(field.type==="number"){
      const inp=el("input",{type:"number",name:field.key,step:"any"});
      inp.addEventListener("change",()=>{
        answers[field.key]=inp.value;
        postAutosaveDebounced(field.key,inp.value);
        updateSummaryUI();
      });
      controlBg.appendChild(inp);
    }
    else {
      const inp=el("input",{type:"text",name:field.key});
      inp.addEventListener("change",()=>{
        answers[field.key]=inp.value;
        postAutosaveDebounced(field.key,inp.value);
        updateSummaryUI();
      });
      controlBg.appendChild(inp);
    }

    if(field.hint){
      f.appendChild(el("div",{class:"hint"},field.hint));
    }
    grid.appendChild(f);
  });
}

/* --- Summary + Progress bar --- */
function updateSummaryUI(){
  const list=qs("#summaryList");
  list.innerHTML="";
  const keys=Object.keys(answers);

  if(keys.length===0){
    list.appendChild(el("div",{class:"small-muted"},"No selections yet"));
  } else {
    keys.slice(0,8).forEach(k=>{
      const v=answers[k];
      const row=el("div",{class:"summary-row"},
        el("div",{},k),
        el("div",{},Array.isArray(v)?v.join(", "):(v===""||v==null?"—":String(v)))
      );
      list.appendChild(row);
    });
  }

  // Progress bar fill
  const total=configFields.length;
  const answered=keys.filter(k=>answers[k]!==undefined && answers[k]!=="").length;
  const pct=total>0?(answered/total)*100:0;
  qs("#progressBar").style.width=pct+"%";
}

/* --- Reset & Submit --- */
qs("#resetBtn").addEventListener("click",()=>{
  answers={};
  localStorage.removeItem("tb_session_id");
  location.reload();
});
qs("#submitBtn").addEventListener("click",()=>{
  fetch(WEBAPP_URL,{
    method:"POST",
    body:JSON.stringify({sessionId,submitted:true,answers}),
    headers:{"Content-Type":"application/json"}
  }).then(r=>r.text()).then(txt=>{
    qs("#message").textContent="Submitted: "+txt;
  }).catch(err=>{
    qs("#message").textContent="Error submitting: "+err;
  });
});

/* --- Load config --- */
fetch(WEBAPP_URL+"?config=true")
  .then(r=>r.json())
  .then(cfg=>{
    buildFormFromConfig(cfg.config || cfg); // supports both simple and updated backend
    updateSummaryUI();
  })
  .catch(err=>{
    qs("#formWrapper").textContent="Error loading form config: "+err;
  });
</script>
</body>
</html>
