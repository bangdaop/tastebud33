<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">

    <title>Taste Buds Choices üòã</title>

    <style>
        body {
            margin: 0;
            font-family: Poppins, Arial;
            background: linear-gradient(180deg, #eaf4ff, #f7fbff);
        }

        #surveyWrap {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 8px;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .08);
        }

        #surveyBar {
            height: 6px;
            background: #ddd;
            border-radius: 6px;
            overflow: hidden;
        }

        #surveyBarInner {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ff7a00, #ffb347);
            transition: .3s;
        }

        #formWrapper {
            padding: 80px 12px 40px;
            max-width: 520px;
            margin: auto;
        }

        .field {
            background: rgba(255, 160, 80, .12);
            backdrop-filter: blur(6px);
            border-radius: 14px;
            padding: 14px;
            margin-bottom: 16px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, .06);
            transition: .3s;
        }

        .field:hover {
            transform: scale(1.01)
        }

        label {
            font-weight: 700;
            display: block;
            margin-bottom: 6px;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #ddd;
            font-size: 15px;
        }

        button {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 14px;
            font-weight: 700;
            background: #ff7a00;
            color: white;
            margin-top: 12px;
        }

        .ageTag {
            margin-top: 6px;
            font-weight: 700;
            color: #ff7a00;
        }

        #thanks {
            text-align: center;
            padding: 40px;
            display: none;
        }
    </style>
</head>

<body>

    <div id="surveyWrap">
        <div id="surveyBar">
            <div id="surveyBarInner"></div>
        </div>
    </div>

    <div id="formWrapper"></div>

    <button id="submitBtn" disabled>Finish</button>

    <div id="thanks"></div>

    <script>

        const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyvtTpTUlPLz_b_maxO8p73hdSd_eNel2SdhrCE6n4KSCy4IBcuaDA0490c2kGEyCt1/exec";

        let sessionId = localStorage.getItem("tb_session_id");
        if (!sessionId) {
            sessionId = 's_' + Math.random().toString(36).slice(2, 12);
            localStorage.setItem("tb_session_id", sessionId);
        }

        const answers = {};
        let configFields = [];
        let cityMap = {};
        let ageTags = {};

        function qs(x) { return document.querySelector(x) }

        function postAutosave(k, v) {
            fetch(WEBAPP_URL, {
                method: 'POST',
                body: JSON.stringify({ sessionId, fieldName: k, fieldValue: v })
            });
        }

        function scrollCard(el) {
            const y = el.getBoundingClientRect().top + window.scrollY - window.innerHeight * 0.33;
            window.scrollTo({ top: y, behavior: 'smooth' });
        }

        function updateSurveyProgress() {
            let done = 0;
            configFields.forEach(f => {
                const v = answers[f.key];
                if (v !== undefined && v !== "") done++;
            });
            const pct = Math.round(done / configFields.length * 100);
            qs('#surveyBarInner').style.width = pct + '%';
            qs('#submitBtn').disabled = done !== configFields.length;
        }

        function el(t, a = {}, ...c) {
            const n = document.createElement(t);
            for (const k in a) n.setAttribute(k, a[k]);
            c.forEach(x => n.append(x));
            return n;
        }

        async function loadConfig() {

            const r = await fetch(WEBAPP_URL);
            const j = await r.json();

            configFields = j.config || [];
            cityMap = j.cityMappings?.cityToState || {};
            (j.ageTags || []).forEach(a => ageTags[a.key] = a.displayLabel);

            buildForm();
        }

        function buildForm() {

            const w = qs('#formWrapper');
            w.innerHTML = '';

            configFields.forEach((f, i) => {

                const box = el('div', { class: 'field' });
                box.append(el('label', {}, f.label));

                let input;

                if (f.type === 'select') {
                    input = el('select');
                    input.append(el('option', { value: '' }, 'Select'));
                    f.options.split(/;|,/).forEach(o => {
                        input.append(el('option', { value: o.trim() }, o.trim()));
                    });

                    input.onchange = () => {
                        answers[f.key] = input.value;
                        postAutosave(f.key, input.value);
                        updateSurveyProgress();

                        if (f.key === "City") {
                            box.append(el('div', { class: 'ageTag' }, cityMap[input.value] || ""));
                        }

                        if (f.key === "Age") {
                            box.append(el('div', { class: 'ageTag' }, ageTags[input.value] || ""));
                        }

                        const next = box.nextElementSibling;
                        if (next) scrollCard(next);
                    };

                    box.append(input);
                }

                else {
                    input = el('input', { type: f.type || 'text' });
                    input.oninput = () => {
                        answers[f.key] = input.value;
                        postAutosave(f.key, input.value);
                        updateSurveyProgress();
                    };
                    box.append(input);
                }

                w.append(box);
            });

        }

        qs('#submitBtn').onclick = () => {

            fetch(WEBAPP_URL, {
                method: 'POST',
                body: JSON.stringify({ sessionId, submitted: true })
            });

            qs('#formWrapper').style.display = 'none';
            qs('#submitBtn').style.display = 'none';

            const t = qs('#thanks');
            t.style.display = 'block';

            let html = "<h2>Thank you guys!! See ya soon with Smoky Flavours üéâ‚ù§Ô∏è‚Äçüî•</h2><br>";

            for (const k in answers) {
                html += `<div><b>${k}</b>: ${answers[k]}</div>`;
            }

            t.innerHTML = html;
        };

        loadConfig();

    </script>

</body>

</html>
