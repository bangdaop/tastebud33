<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Taste Buds Choices</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#fff7ed; --bg2:#fff1e6; --card:#ffffff; --accent:#ff7a00; --accent-2:#0d3b66;
    --muted:#6b7280; --radius:14px; --shadow:0 18px 50px rgba(13,59,102,0.08);
  }
  html,body{height:100%;margin:0;font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#111827}
  body{
    display:flex;align-items:center;justify-content:center;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    padding:36px;
  }
  .app { width:100%;max-width:980px;background:linear-gradient(180deg,rgba(255,255,255,0.98),#fff);
    border-radius:18px;box-shadow:var(--shadow);overflow:hidden;border:1px solid rgba(13,59,102,0.04); }
  header{padding:28px 36px 12px;background:linear-gradient(180deg,rgba(13,59,102,0.02),transparent)}
  h1{margin:0;font-size:30px;color:var(--accent-2);text-align:center;font-weight:700;letter-spacing:-0.2px}
  .tagline{margin-top:8px;text-align:center;color:var(--muted);font-size:15px;line-height:1.35}
  main{padding:20px 28px 28px}
  .layout{display:grid;grid-template-columns:1fr 360px;gap:22px}
  @media (max-width:920px){.layout{grid-template-columns:1fr}}
  .card{background:var(--card);border-radius:12px;padding:14px;border:1px solid rgba(13,59,102,0.03)}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:720px){.form-grid{grid-template-columns:1fr}}
  .field{display:flex;flex-direction:column;gap:8px}
  label{font-weight:600;color:#0f172a;font-size:14px}
  select,input,textarea{font-size:15px;padding:10px;border-radius:10px;border:1px solid #e6eef6;background:#fff;outline:none}
  select:focus,input:focus,textarea:focus{box-shadow:0 6px 18px rgba(13,59,102,0.06);border-color:var(--accent)}
  .hint{font-size:13px;color:var(--muted)}
  .age-panel{display:flex;flex-direction:column;gap:6px;padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(247,247,250,0.9),#fff)}
  .age-tagline{font-weight:700;color:var(--accent-2);font-size:14px}
  .age-desc{font-size:13px;color:var(--muted)}
  .controls{display:flex;gap:12px;align-items:center;justify-content:flex-end;margin-top:18px}
  .btn-primary{background:linear-gradient(180deg,var(--accent),#d95b00);color:white;border:none;padding:12px 18px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 10px 30px rgba(255,122,0,0.12)}
  .btn-secondary{background:transparent;border:1px solid #e6eef6;padding:10px 14px;border-radius:10px;cursor:pointer}
  .thanks{display:flex;flex-direction:column;align-items:center;gap:12px;padding:28px;text-align:center}
  .small-muted{font-size:13px;color:var(--muted)}
  .loader{width:18px;height:18px;border-radius:50%;border:3px solid rgba(0,0,0,0.06);border-top-color:var(--accent);animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .debug{font-family:monospace;font-size:12px;color:#0b1220;background:#f8fafc;padding:8px;border-radius:8px;margin-top:12px;display:none}
  .sidebar{display:flex;flex-direction:column;gap:12px}
  .summary-card{display:flex;flex-direction:column;gap:8px}
  .summary-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:linear-gradient(180deg,#fff,#fbfbff);border:1px solid rgba(13,59,102,0.03)}
</style>
</head>
<body>
  <div class="app" role="application" aria-labelledby="appTitle">
    <header>
      <h1 id="appTitle">Taste Buds Choices</h1>
      <div class="tagline">Pick your combo ‚Äì we‚Äôre dropping it near you. Lock your picks and we will deliver vibes üòç</div>
    </header>

    <main>
      <div class="layout">
        <div class="card" id="leftCard">
          <div id="formArea" aria-live="polite">
            <div id="loading" style="display:flex;align-items:center;gap:10px">
              <div class="loader" aria-hidden="true"></div>
              <div class="small-muted">Loading form‚Ä¶</div>
            </div>
          </div>

          <div class="controls" style="margin-top:12px">
            <button id="resetBtn" class="btn-secondary" type="button" title="Reset form">Reset</button>
            <button id="submitBtn" class="btn-primary" type="button" title="Finish">Finish</button>
          </div>

          <div id="message" style="margin-top:12px"></div>
          <div id="debug" class="debug" aria-hidden="true"></div>
        </div>

        <aside class="sidebar">
          <div class="card summary-card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">Your quick summary</div>
              <div class="small-muted" id="sessionIdDisplay"></div>
            </div>
            <div id="summaryList" style="display:flex;flex-direction:column;gap:8px;margin-top:6px"></div>
            <div class="small-muted" style="font-size:12px">Changes autosave as you interact.</div>
          </div>

          <div class="card">
            <div style="font-weight:700;margin-bottom:6px">Tips</div>
            <div class="small-muted">If age tag doesn't appear, add an AgeTags sheet and ensure keys match ageGroup options.</div>
          </div>
        </aside>
      </div>
    </main>
  </div>

<script>
/* WEBAPP URL */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwAn--D_OWt4uFwJV6zn-EiilyOgnFNNuenusA3UwBj2HU81vRtZiwrAQ2G5mH9U-Q/exec";

/* session */
let sessionId = localStorage.getItem("tb_session_id");
if (!sessionId) {
  sessionId = 's_' + Math.random().toString(36).slice(2,12);
  localStorage.setItem("tb_session_id", sessionId);
}
document.getElementById('sessionIdDisplay').textContent = sessionId;

const answers = {};
let configFields = [];
let AGE_TAGS_MAP = {};

/* helpers */
function el(tag, attrs = {}, ...children) {
  const node = document.createElement(tag);
  for (const k in attrs) {
    if (k === 'class') node.className = attrs[k];
    else if (k === 'html') node.innerHTML = attrs[k];
    else node.setAttribute(k, attrs[k]);
  }
  children.forEach(c => { if (c !== null && c !== undefined) node.appendChild(typeof c === 'string' ? document.createTextNode(c) : c); });
  return node;
}
function qs(sel, root = document) { return root.querySelector(sel); }
function qsa(sel, root = document) { return Array.from(root.querySelectorAll(sel)); }
function showMessage(text, type = 'info') {
  const msg = qs('#message'); msg.innerHTML = '';
  const div = el('div', { class: type === 'error' ? 'error' : 'small-muted' }, text);
  msg.appendChild(div);
}
function clearMessage(){ qs('#message').innerHTML = ''; }
function setDebug(text) { const d = qs('#debug'); d.style.display = text ? 'block' : 'none'; d.textContent = text || ''; }

/* network */
async function fetchWithTimeout(url, opts = {}, timeout = 9000) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);
  try {
    const res = await fetch(url, { signal: controller.signal, ...opts });
    clearTimeout(id);
    return res;
  } catch (err) { clearTimeout(id); throw err; }
}
async function postJson(url, body, timeout = 9000, retries = 2) {
  const opts = { method: 'POST', body: JSON.stringify(body) };
  for (let i = 0; i <= retries; i++) {
    try {
      const r = await fetchWithTimeout(url, opts, timeout);
      if (!r.ok) throw new Error('Network response not ok: ' + r.status);
      return await r.json().catch(()=>({status:'ok'}));
    } catch (err) {
      if (i === retries) throw err;
      await new Promise(res => setTimeout(res, 300 * (i+1)));
    }
  }
}

/* ageTags mapping */
function mapAgeTags(ageTagsArray) {
  AGE_TAGS_MAP = {};
  (ageTagsArray || []).forEach(r => {
    const key = (r.key || r.Key || r.displayLabel || r.displaylabel || '').toString().trim();
    if (!key) return;
    AGE_TAGS_MAP[key] = {
      displayLabel: r.displayLabel || r.displaylabel || r.display || r.key || key,
      tagline: r.tagline || r.Tagline || r.description || '',
      description: r.description || r.Description || '',
      responseTone: r.responseTone || r.response_tone || ''
    };
  });
  console.log('AGE_TAGS_MAP', AGE_TAGS_MAP);
}

/* build form */
function buildFormFromConfig(config) {
  configFields = config.map(c => {
    return {
      label: (c.label || c.Label || c.LABEL || c.key || '').toString(),
      type: (c.type || c.Type || c.TYPE || '').toString().toLowerCase(),
      key: (c.key || c.Key || c.KEY || c.label || '').toString(),
      options: (c.options || c.Options || c.OPTIONS || '').toString(),
      category: (c.category || c.Category || c.CATEGORY || '').toString(),
      price: (c.price || c.Price || c.PRICE || '').toString()
    };
  }).filter(f => f.key && f.label);

  const container = qs('#formArea'); container.innerHTML = '';
  const grid = el('div', { class: 'form-grid' }); container.appendChild(grid);

  configFields.forEach(field => {
    const wrapper = el('div', { class: 'field' });
    const label = el('label', {}, field.label);
    wrapper.appendChild(label);

    const attachAutosave = (inputEl, key) => {
      if (!inputEl) return;
      const save = (val, extra = {}) => {
        answers[key] = val;
        postAutosaveDebounced(key, val, extra);
        updateSummaryUI();
      };
      if (inputEl.tagName === 'SELECT' || inputEl.type === 'checkbox' || inputEl.type === 'radio') {
        inputEl.addEventListener('change', () => {
          if (inputEl.type === 'checkbox') save(inputEl.checked);
          else save(inputEl.value);
        });
      } else {
        inputEl.addEventListener('blur', () => save(inputEl.value));
        inputEl.addEventListener('change', () => save(inputEl.value));
      }
    };

    if (field.type === 'select') {
      const sel = el('select'); sel.name = field.key;
      const placeholder = el('option', { value: '', disabled: true, selected: true }, 'Select');
      sel.appendChild(placeholder);

      // If this is the city field, sort options alphabetically before adding
      if (String(field.key).toLowerCase().indexOf('city') !== -1 && field.options) {
        const opts = field.options.split(/;|,/).map(s => s.trim()).filter(Boolean);
        // Sort using localeCompare for natural alphabetical order
        opts.sort((a,b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
        opts.forEach(opt => sel.appendChild(el('option', { value: opt }, opt)));
      } else {
        if (field.options) {
          field.options.split(/;|,/).map(s => s.trim()).filter(Boolean).forEach(opt => {
            sel.appendChild(el('option', { value: opt }, opt));
          });
        }
      }

      if (field.key.toLowerCase().includes('city')) {
        const stateLine = el('div', { class: 'hint' }, '');
        sel.addEventListener('change', () => {
          const city = sel.value;
          const state = (window.cityToState && window.cityToState[city]) || '';
          const region = (window.cityToRegion && window.cityToRegion[city]) || '';
          if (state) stateLine.textContent = `State: ${state} ‚Ä¢ Region: ${region}`;
          const ph = sel.querySelector('option[value=""]'); if (ph) ph.remove();
          postAutosaveDebounced(field.key, city, { state, region });
          answers[field.key] = city; answers.state = state; answers.region = region;
          updateSummaryUI();
        });
        wrapper.appendChild(sel); wrapper.appendChild(stateLine);
      } else {
        sel.addEventListener('change', () => {
          const ph = sel.querySelector('option[value=""]'); if (ph) ph.remove();
        });
        wrapper.appendChild(sel); attachAutosave(sel, field.key);
      }
    }
    else if (field.type === 'radio') {
      const opts = field.options ? field.options.split(/;|,/).map(s => s.trim()).filter(Boolean) : [];
      const group = el('div', {});
      opts.forEach((opt, idx) => {
        const id = `r_${field.key}_${idx}`;
        const labelEl = el('label', {});
        const radio = el('input', { type: 'radio', name: field.key, id, value: opt });
        radio.addEventListener('change', () => {
          answers[field.key] = opt; postAutosaveDebounced(field.key, opt); updateSummaryUI();
        });
        labelEl.appendChild(radio); labelEl.appendChild(document.createTextNode(' ' + opt));
        group.appendChild(labelEl);
      });
      wrapper.appendChild(group);
    }
    else if (field.type === 'checkbox') {
      const opts = field.options ? field.options.split(/;|,/).map(s => s.trim()).filter(Boolean) : [];
      const group = el('div', {});
      opts.forEach((opt, idx) => {
        const id = `c_${field.key}_${idx}`;
        const labelEl = el('label', {});
        const cb = el('input', { type: 'checkbox', id, value: opt });
        cb.addEventListener('change', () => {
          const arr = qsa(`input[type="checkbox"][value]`).filter(i => i.checked && i.closest('.field') === wrapper).map(i => i.value);
          answers[field.key] = arr; postAutosaveDebounced(field.key, arr); updateSummaryUI();
        });
        labelEl.appendChild(cb); labelEl.appendChild(document.createTextNode(' ' + opt));
        group.appendChild(labelEl);
      });
      wrapper.appendChild(group);
    }
    else if (field.type === 'textarea') {
      const ta = el('textarea', { rows: 4, name: field.key });
      wrapper.appendChild(ta); attachAutosave(ta, field.key);
    }
    else {
      const inp = el('input', { type: 'text', name: field.key, autocomplete: 'off' });
      wrapper.appendChild(inp); attachAutosave(inp, field.key);
    }

    const hintParts = [];
    if (field.category) hintParts.push(field.category);
    if (field.price) hintParts.push('price: ' + field.price);
    if (hintParts.length) wrapper.appendChild(el('div', { class: 'hint' }, hintParts.join(' ‚Ä¢ ')));

    grid.appendChild(wrapper);
  });

  grid.appendChild(el('div', { class: 'full' }, el('div', { class: 'small-muted' }, 'Tip: update the Config or AgeTags sheet to change fields and taglines.')));
  attachAgeTaglineBehavior();
  updateSummaryUI();
}

/* autosave debounce */
let autosaveTimer = null;
const AUTOSAVE_DELAY = 600;
function postAutosaveDebounced(fieldName, fieldValue, extra = {}) {
  if (autosaveTimer) clearTimeout(autosaveTimer);
  autosaveTimer = setTimeout(() => {
    const payload = { sessionId, fieldName, fieldValue, ...extra };
    postJson(WEBAPP_URL, payload, 7000, 1).catch(err => {
      console.warn('Autosave failed', err);
      showMessage('Autosave temporarily failed. Changes will retry on submit.', 'error');
      setTimeout(clearMessage, 4000);
    });
  }, AUTOSAVE_DELAY);
}

/* load config and ageTags */
async function loadConfigAndBuild() {
  const loading = qs('#loading'); loading.style.display = 'flex';
  try {
    const res = await fetchWithTimeout(WEBAPP_URL + '?_t=' + Date.now(), {}, 9000);
    const json = await res.json();
    setDebug(JSON.stringify(json, null, 2));
    if (json && json.status === 'ok' && Array.isArray(json.config)) {
      if (Array.isArray(json.ageTags)) mapAgeTags(json.ageTags);
      buildFormFromConfig(json.config);
      clearMessage();
    } else {
      throw new Error('Invalid config response');
    }
  } catch (err) {
    console.error('Failed to load config', err);
    const container = qs('#formArea'); container.innerHTML = '';
    container.appendChild(el('div', { class: 'error' }, 'Unable to load form configuration. Check Config and AgeTags sheets and Apps Script deployment.'));
    showMessage('Error loading form. Confirm the web app URL and that the script is deployed with correct access.', 'error');
  } finally {
    loading.style.display = 'none';
  }
}

/* age tagline UI */
function attachAgeTaglineBehavior() {
  const ageSelect = document.querySelector('select[name="ageGroup"]') ||
    Array.from(document.querySelectorAll('select')).find(s => s.previousSibling && s.previousSibling.textContent && s.previousSibling.textContent.toLowerCase().includes('age'));
  if (!ageSelect) return;

  let panel = ageSelect.parentNode.querySelector('.age-panel');
  if (!panel) {
    panel = el('div', { class: 'age-panel' });
    ageSelect.parentNode.appendChild(panel);
  }
  panel.innerHTML = '';
  const tagNode = el('div', { class: 'age-tagline' }, '');
  const descNode = el('div', { class: 'age-desc' }, '');
  panel.appendChild(tagNode); panel.appendChild(descNode);

  ageSelect.addEventListener('change', () => {
    const val = ageSelect.value;
    const info = AGE_TAGS_MAP[val] || AGE_TAGS_MAP[val.trim()] || null;
    if (info) {
      tagNode.textContent = info.displayLabel || val;
      descNode.textContent = info.tagline || info.description || '';
    } else {
      tagNode.textContent = val || '';
      descNode.textContent = 'Tip: add an AgeTags sheet with matching keys to show richer taglines.';
    }
  });

  if (ageSelect.value) ageSelect.dispatchEvent(new Event('change'));
}

/* summary UI */
function updateSummaryUI() {
  const list = qs('#summaryList'); list.innerHTML = '';
  const keys = Object.keys(answers);
  if (keys.length === 0) {
    list.appendChild(el('div', { class: 'small-muted' }, 'No selections yet'));
    return;
  }
  keys.slice(0, 8).forEach(k => {
    const v = answers[k];
    const row = el('div', { class: 'summary-row' },
      el('div', {}, k),
      el('div', {}, (Array.isArray(v) ? v.join(', ') : (v === '' || v === null ? '‚Äî' : String(v))))
    );
    list.appendChild(row);
  });
}

/* final submit */
async function handleSubmit() {
  const submitBtn = qs('#submitBtn'); submitBtn.disabled = true; submitBtn.textContent = 'Submitting...';
  try {
    configFields.forEach(f => {
      if (!f.key) return;
      const name = f.key;
      if (f.type === 'radio') {
        const checked = qsa(`input[type="radio"][name="${name}"]`).find(i => i.checked);
        if (checked) answers[name] = checked.value;
      } else if (f.type === 'checkbox') {
        const checked = qsa(`input[type="checkbox"]`).filter(i => i.checked && i.closest('.field'));
        answers[name] = checked.map(i => i.value);
      } else if (f.type === 'select') {
        const sel = qsa('select').find(s => s.name === name);
        if (sel) answers[name] = sel.value;
      } else {
        const inp = qsa('input,textarea').find(i => i.name === name);
        if (inp) answers[name] = inp.value;
      }
    });

    const payload = { sessionId, submitted: true, answers };
    await postJson(WEBAPP_URL, payload, 10000, 2);

    const left = qs('#leftCard'); left.innerHTML = '';
    left.appendChild(el('div', { class: 'thanks' },
      el('h2', {}, 'Thanks for completing Taste Buds Choices! üéâ'),
      el('div', { class: 'small-muted' }, 'We saved your picks. You can close this window now.'),
      el('button', { class: 'btn-primary', onclick: 'window.location.reload()' }, 'Done')
    ));
  } catch (err) {
    console.error('Submit failed', err);
    showMessage('Submission failed. Check connection and try again.', 'error');
    submitBtn.disabled = false; submitBtn.textContent = 'Finish';
  }
}

/* reset */
function resetFormLocal() {
  for (const k in answers) delete answers[k];
  qsa('input,textarea,select').forEach(i => {
    if (i.tagName === 'SELECT') i.selectedIndex = 0;
    else if (i.type === 'radio' || i.type === 'checkbox') i.checked = false;
    else i.value = '';
  });
  updateSummaryUI();
  showMessage('Form reset locally. Autosaved rows remain in Responses sheet.', 'info');
  setTimeout(clearMessage, 3000);
}

/* init */
document.addEventListener('DOMContentLoaded', () => {
  qs('#submitBtn').addEventListener('click', handleSubmit);
  qs('#resetBtn').addEventListener('click', resetFormLocal);
  loadConfigAndBuild();
});
</script>
</body>
</html>
