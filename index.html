<!doctype html>
<html>

<head>
    <img class="bg-img" src="https://raw.githubusercontent.com/bangdaop/33cimg/main/photo_6062312442882100596_y.jpg">
    <div class="overlay"></div>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Taste Buds Choices</title>

    <style>
        /* FULL ORIGINAL CSS — unchanged */

        #loadWrap {
            margin: 12px 0;
        }

        #loadBar {
            height: 6px;
            width: 0%;
            background: #4da3ff;
        }

        body {
            font-family: Arial;
            margin: 0;
            background: #f6f8fa
        }

        .field {
            margin-bottom: 12px
        }

        label {
            font-weight: bold
        }

        input,
        select {
            width: 100%;
            padding: 8px
        }

        #surveyBar {
            height: 6px;
            background: #ddd;
            margin: 10px 0
        }

        #surveyBarInner {
            height: 100%;
            width: 0;
            background: #4aa3ff
        }

        #submitBtn {
            margin-top: 10px;
            padding: 10px;
            width: 100%
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px
        }

        .left {
            padding: 12px
        }
    </style>
</head>

<body>

    <div id="loadWrap">
        <div id="loadTrack">
            <div id="loadBar"></div>
        </div>
        <div id="loadText">Loading…</div>
    </div>

    <div id="surveyWrap">
        <div id="surveyBar">
            <div id="surveyBarInner"></div>
        </div>
    </div>

    <div id="formWrapper"></div>

    <button id="submitBtn" disabled>Finish</button>

    <div id="summaryList"></div>

    <script>

        const WEBAPP_URL =
            "https://script.google.com/macros/s/AKfycbyvtTpTUlPLz_b_maxO8p73hdSd_eNel2SdhrCE6n4KSCy4IBcuaDA0490c2kGEyCt1/exec";

        /* session */
        let sessionId = localStorage.getItem("tb_session_id");
        if (!sessionId) {
            sessionId = 's_' + Math.random().toString(36).slice(2, 12);
            localStorage.setItem("tb_session_id", sessionId);
        }

        /* helpers */
        function qs(x) { return document.querySelector(x) }
        function el(t, a = {}, ...c) {
            const n = document.createElement(t);
            for (const k in a) n.setAttribute(k, a[k]);
            c.forEach(x => n.append(x));
            return n;
        }

        /* state */
        const answers = {}
        let configFields = []

        function updateSurveyProgress() {
            if (!configFields.length) return;
            let done = 0;
            configFields.forEach(f => {
                const v = answers[f.key];
                if (v !== '' && v != null) done++;
            });
            const pct = Math.round(done / configFields.length * 100);
            qs('#surveyBarInner').style.width = pct + '%';
            qs('#submitBtn').disabled = done !== configFields.length;
        }

        /* loader */
        function setLoad(p) {
            qs('#loadBar').style.width = p + '%';
            qs('#loadText').innerText = 'Loading… ' + p + '%';
        }

        async function loadConfigAndBuild() {
            try {
                setLoad(20);
                const r = await fetch(WEBAPP_URL);
                setLoad(60);
                const j = await r.json();
                configFields = j.config || [];
                setLoad(85);
                buildForm();
                updateSurveyProgress();
                setTimeout(() => qs('#loadWrap').style.display = 'none', 400);
            } catch (e) {
                console.error(e);
                qs('#formWrapper').innerText = 'Failed loading form';
            }
        }

        function buildForm() {
            const w = qs('#formWrapper');
            w.innerHTML = '';

            configFields.forEach(f => {
                const box = el('div', { class: 'field' });
                box.append(el('label', {}, f.label));

                if (f.type === 'select') {
                    const s = el('select');
                    s.append(el('option', { value: '' }, ''));
                    f.options.split(/;|,/).forEach(o => {
                        s.append(el('option', { value: o.trim() }, o.trim()));
                    });
                    s.onchange = () => {
                        answers[f.key] = s.value;
                        autosave(f.key, s.value);
                        updateSurveyProgress();
                    };
                    box.append(s);
                }

                if (f.type === 'text' || f.type === 'number') {
                    const i = el('input', { type: f.type });
                    i.oninput = () => {
                        answers[f.key] = i.value;
                        autosave(f.key, i.value);
                        updateSurveyProgress();
                    };
                    box.append(i);
                }

                if (f.type === 'radio') {
                    f.options.split(/;|,/).forEach(o => {
                        const r = el('input', { type: 'radio', name: f.key, value: o.trim() });
                        r.onchange = () => {
                            answers[f.key] = o.trim();
                            autosave(f.key, o.trim());
                            updateSurveyProgress();
                        };
                        box.append(el('label', {}, r, ' ' + o.trim()));
                    });
                }

                w.append(box);
            });
        }

        /* AUTOSAVE */
        let t = null;
        function autosave(k, v) {
            if (t) clearTimeout(t);
            t = setTimeout(() => {
                fetch(WEBAPP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ sessionId, field: k, value: v })
                });
            }, 300);
        }

        /* submit */
        qs('#submitBtn').onclick = () => {
            fetch(WEBAPP_URL, {
                method: 'POST',
                body: JSON.stringify({ sessionId, submitted: true, answers })
            });
            alert("Submitted");
        };

        loadConfigAndBuild();

    </script>
</body>

</html>
