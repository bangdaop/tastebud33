<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Taste Buds Choices</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        #progressLabel,
        #surveyText {
            display: none !important;
        }

        .field input,
        .field textarea,
        .field select {
            width: 100% !important;
        }

        :root {
            --bg1: #f6f8fa;
            --bg2: #eef2f5;
            --card: #ffffff;
            --accent: #ff7a00;
            --accent-2: #0d3b66;
            --muted: #6b7280;
            --radius: 12px;
            --shadow: 0 14px 40px rgba(13, 59, 102, 0.08);
            --gap: 14px;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
            color: #111827;
            background: linear-gradient(180deg, var(--bg1), var(--bg2));
            -webkit-font-smoothing: antialiased
        }

        .app {
            max-width: 980px;
            margin: 20px auto;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow);
            background: linear-gradient(180deg, #fff, #fbfbff);
            border: 1px solid rgba(13, 59, 102, 0.04)
        }

        header {
            position: relative;
            padding: 22px 20px 28px;
            text-align: center;
            color: #fff;
            background-color: rgba(13, 59, 102, 0.06);
            overflow: visible;
            min-height: 120px
        }

        header .bg-img {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
            opacity: 0.98
        }

        header .overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(13, 59, 102, 0.18), rgba(13, 59, 102, 0.12));
            z-index: 1
        }

        header .content {
            position: relative;
            z-index: 2
        }

        h1 {
            position: relative;
            display: inline-block;
            margin: 0;
            font-size: 30px;
            color: #ffea00;
            font-weight: 800;
            padding: 6px 14px;
            border-radius: 10px;
            text-shadow: 0 0 8px #ff2828, 0 0 16px #ff2828, 0 0 24px #ff4444, 0 0 32px #ff2828, 0 0 40px rgba(255, 68, 68, .6), 0 0 60px rgba(255, 40, 40, .4), 0 4px 16px rgba(0, 0, 0, .3)
        }

        .tagline {
            position: relative;
            display: inline-block;
            margin-top: 8px;
            color: #ffea66;
            font-size: 20px;
            line-height: 1.3;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 8px;
            text-shadow: 0 0 6px #ff2828, 0 0 12px #ff2828, 0 0 18px #ff4444, 0 0 24px rgba(255, 40, 40, .5), 0 0 32px rgba(255, 68, 68, .4)
        }

        main {
            display: flex;
            gap: var(--gap);
            padding: 16px
        }

        .left {
            flex: 1;
            min-width: 0
        }

        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid rgba(13, 59, 102, 0.03)
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 6px;
            padding: 6px;
            border-radius: 10px
        }

        label {
            font-weight: 600;
            color: #0f172a;
            font-size: 13px
        }

        .control-bg {
            background: linear-gradient(180deg, rgba(238, 242, 245, 0.9), rgba(246, 248, 250, 0.95));
            border-radius: 10px;
            padding: 6px
        }

        select,
        input,
        textarea {
            font-size: 15px;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(13, 59, 102, 0.06);
            background: transparent;
            color: #0f172a;
            width: 100%;
            box-sizing: border-box
        }

        .hint {
            font-size: 12px;
            color: var(--muted);
            margin-top: 6px
        }

        .age-panel {
            margin-top: 8px;
            padding: 10px;
            border-radius: 10px;
            background: linear-gradient(180deg, #fff, #fcfcff);
            border: 1px solid rgba(13, 59, 102, 0.03)
        }

        .age-tagline {
            font-weight: 700;
            color: var(--accent-2);
            font-size: 14px
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            background: linear-gradient(180deg, #fff, #fbfbff);
            border: 1px solid rgba(13, 59, 102, 0.03);
            font-size: 13px
        }

        .controls {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 14px
        }

        .btn-primary {
            background: linear-gradient(180deg, var(--accent), #d95b00);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid #e6eef6;
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer
        }

        .small-muted {
            font-size: 13px;
            color: var(--muted)
        }

        .sidebar {
            width: 320px;
            display: flex;
            flex-direction: column;
            gap: 12px
        }

        @media (max-width:820px) {
            main {
                flex-direction: column;
                padding: 12px
            }

            .form-grid {
                grid-template-columns: 1fr
            }

            .sidebar {
                display: none
            }

            .controls {
                display: flex
            }

            .app {
                margin: 8px
            }

            header {
                padding: 18px
            }
        }

        #progressWrap {
            position: relative;
            height: 6px;
            background: transparent;
            border-radius: 6px;
            overflow: hidden;
            margin: 8px 0 6px
        }

        #progressBar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #cfe9ff, #9fd6ff);
            box-shadow: 0 6px 18px rgba(31, 120, 255, 0.08);
            transition: width 300ms ease
        }

        #progressLabel {
            font-size: 12px;
            color: var(--muted);
            margin-top: 6px;
            text-align: center
        }

        #surveyWrap {
            margin-top: 8px
        }

        #surveyBar {
            height: 6px;
            background: #e6f2ff;
            border-radius: 6px;
            overflow: hidden
        }

        #surveyBarInner {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #cfe9ff, #9fd6ff);
            transition: width 300ms ease
        }

        #surveyText {
            font-size: 12px;
            color: var(--muted);
            margin-top: 4px;
            text-align: center
        }
    </style>
</head>

<body>
    <div class="app" role="application" aria-labelledby="appTitle">
        <header>
            <img class="bg-img" id="headerBg" alt="header background"
                src="https://raw.githubusercontent.com/bangdaop/33cimg/refs/heads/main/photo_6062312442882100596_y.jpg"
                onerror="this.style.display='none';document.querySelector('header').style.background='linear-gradient(180deg,#0d3b66,#1f6fbf)';" />
            <div class="overlay"></div>
            <div class="content">
                <h1 id="appTitle">Taste Buds Choices</h1>
                <div class="tagline">Pick your combo â€” weâ€™ll drop it near you. Lock your picks and weâ€™ll deliver vibes.
                </div>
            </div>
        </header>
        <main>
            <div class="left">
                <div id="formArea" class="card" aria-live="polite">
                    <div id="progressWrap">
                        <div id="progressBar"></div>
                    </div>
                    <div id="progressLabel">Loading formâ€¦</div>
                    <div id="surveyWrap" style="display:none">
                        <div id="surveyBar">
                            <div id="surveyBarInner"></div>
                        </div>
                        <div id="surveyText"></div>
                    </div>
                    <div id="formWrapper" style="margin-top:12px;"></div>
                </div>
                <div class="controls" style="margin-top:12px">
                    <button id="resetBtn" class="btn-secondary" type="button">Reset</button>
                    <button id="submitBtn" class="btn-primary" type="button">Finish</button>
                </div>
                <div id="message" style="margin-top:12px"></div>
            </div>
            <aside class="sidebar">
                <div class="card">
                    <div style="font-weight:700;margin-bottom:6px">Your quick summary</div>
                    <div id="summaryList" style="display:flex;flex-direction:column;gap:8px"></div>
                    <div class="small-muted" style="font-size:12px;margin-top:8px">Autosaves as you interact.</div>
                </div>
            </aside>
        </main>
    </div>
    <script>
        const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwXlYjodsqdwXD1lpUObHRUxO-4g99cRvMU77rJ3YMi7ySHMHmiLM-hNceq5RvbCTUw/exec";
        let sessionId = localStorage.getItem("tb_session_id");

        if (!sessionId) {
            sessionId = 's_' + Math.random().toString(36).slice(2, 12);
            localStorage.setItem("tb_session_id", sessionId);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const d = document.getElementById('sessionIdDisplay');
            if (d) d.textContent = '';
        });

        function el(tag, attrs = {}, ...children) { const node = document.createElement(tag); for (const k in attrs) { if (k === 'class') node.className = attrs[k]; else if (k === 'html') node.innerHTML = attrs[k]; else node.setAttribute(k, attrs[k]); } children.forEach(c => { if (c !== null && c !== undefined) node.appendChild(typeof c === 'string' ? document.createTextNode(c) : c); }); return node }
        function qs(s, r = document) { return r.querySelector(s) }
        function qsa(s, r = document) { return Array.from(r.querySelectorAll(s)) }
        function showMessage(t) { qs('#message').innerHTML = ''; qs('#message').appendChild(el('div', { class: 'small-muted' }, t)) }
        function clearMessage() { qs('#message').innerHTML = '' }
        async function fetchWithTimeout(url, opts = {}, timeout = 9000) { const c = new AbortController(); const id = setTimeout(() => c.abort(), timeout); try { const r = await fetch(url, { signal: c.signal, ...opts }); clearTimeout(id); return r } catch (e) { clearTimeout(id); throw e } }
        async function postJson(url, body, timeout = 9000, retries = 2) { const opts = { method: 'POST', body: JSON.stringify(body) }; for (let i = 0; i <= retries; i++) { try { const r = await fetchWithTimeout(url, opts, timeout); if (!r.ok) throw new Error('Network ' + r.status); return await r.json().catch(() => ({ status: 'ok' })) } catch (e) { if (i === retries) throw e; await new Promise(res => setTimeout(res, 300 * (i + 1))) } } }
        function normalizeKey(s) { if (!s && s !== 0) return ''; let t = String(s).replace(/[\u200B-\u200F\uFEFF]/g, '').replace(/[\u2012-\u2015]/g, '-').replace(/\s+/g, ' ').trim(); return t.toLowerCase() }
        function stripEmoji(s) { if (!s) return s; return s.replace(/[\u{1F300}-\u{1F6FF}\u{1F900}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, '').trim() }
        window.AGE_TAGS_MAP = {}; window.cityToState = {}; let configFields = []; const answers = {};
        function mapAgeTagsFromJson(a) { window.AGE_TAGS_MAP = {}; (a || []).forEach(r => { const raw = (r.key || '').toString().trim(); if (!raw) return; const display = (r.displayLabel || r.display || raw).toString(); window.AGE_TAGS_MAP[raw] = { displayLabel: display }; const norm = normalizeKey(raw); if (norm && !window.AGE_TAGS_MAP[norm]) window.AGE_TAGS_MAP[norm] = window.AGE_TAGS_MAP[raw]; const stripped = normalizeKey(stripEmoji(raw)); if (stripped && !window.AGE_TAGS_MAP[stripped]) window.AGE_TAGS_MAP[stripped] = window.AGE_TAGS_MAP[raw] }) }
        function updateSurveyProgress() {
            if (!configFields.length) return; let done = 0; configFields.forEach(f => { const v = answers[f.key]; if (Array.isArray(v) ? v.length : (v !== '' && v != null)) done++ }); const pct = Math.round(done / configFields.length * 100); const submitBtn = qs('#submitBtn');
            if (submitBtn) {
                submitBtn.disabled = done !== configFields.length;
                submitBtn.style.opacity = done === configFields.length ? '1' : '0.5';
            }
            qs('#surveyWrap').style.display = 'block'; qs('#surveyBarInner').style.width = pct + '%'; qs('#surveyText').textContent = `${done} / ${configFields.length} completed`
        }
        function updateSummaryUI() {
            const list = qs('#summaryList'); list.innerHTML = ''; const keys = configFields.map(f => f.key).filter(k => answers[k] !== undefined && k.toLowerCase() !== 'intro');
            if (keys.length === 0) { list.appendChild(el('div', { class: 'small-muted' }, 'No selections yet')); updateSurveyProgress(); return; } keys.slice(0, 8).forEach(k => { const v = answers[k]; list.appendChild(el('div', { class: 'summary-row' }, el('div', {}, k), el('div', {}, Array.isArray(v) ? v.join(', ') : (v === '' || v === null ? 'â€”' : String(v))))) }); updateSurveyProgress()
        }
        function buildFormFromConfig(config) {
            configFields = config.map(c => ({ label: (c.label || '').toString(), type: (c.type || '').toString().toLowerCase(), key: (c.key || '').toString(), options: (c.options || '').toString(), category: (c.category || '').toString(), price: (c.price || '').toString() })).filter(f => f.key && f.label); const wrapper = qs('#formWrapper'); wrapper.innerHTML = ''; const grid = el('div', { class: 'form-grid' }); configFields.forEach(field => {
                const fld = el('div', { class: 'field' }); fld.appendChild(el('label', {}, field.label)); const controlBg = el('div', { class: 'control-bg' }); if (field.type === 'select') { const sel = el('select', { name: field.key }); sel.appendChild(el('option', { value: '', disabled: true, selected: true }, 'Select')); const rawOpts = field.options ? field.options.split(/;|,/).map(s => s.trim()).filter(Boolean) : []; if (String(field.key).toLowerCase().includes('city') && rawOpts.length) { rawOpts.sort((a, b) => a.localeCompare(b)); rawOpts.forEach(opt => sel.appendChild(el('option', { value: opt }, opt))); const stateInput = el('input', { readonly: true, placeholder: 'State' }); sel.addEventListener('change', () => { const city = sel.value; const state = (window.cityToState && window.cityToState[city]) || ''; answers[field.key] = city; answers.state = state; stateInput.value = state; postAutosaveDebounced(field.key, city, { state }); updateSummaryUI() }); controlBg.appendChild(sel); controlBg.appendChild(stateInput) } else { rawOpts.forEach(opt => sel.appendChild(el('option', { value: opt }, opt))); sel.addEventListener('change', () => { answers[field.key] = sel.value; postAutosaveDebounced(field.key, sel.value); updateSummaryUI() }); controlBg.appendChild(sel) } } else if (field.type === 'radio') { const opts = field.options ? field.options.split(/;|,/).map(s => s.trim()).filter(Boolean) : []; const group = el('div'); opts.forEach((opt, idx) => { const id = `r_${field.key}_${idx}`; const labelEl = el('label', {}); const radio = el('input', { type: 'radio', name: field.key, id, value: opt }); radio.addEventListener('change', () => { answers[field.key] = opt; postAutosaveDebounced(field.key, opt); updateSummaryUI() }); labelEl.appendChild(radio); labelEl.appendChild(document.createTextNode(' ' + opt)); group.appendChild(labelEl) }); controlBg.appendChild(group) } else if (field.type === 'checkbox') { const opts = field.options ? field.options.split(/;|,/).map(s => s.trim()).filter(Boolean) : []; const group = el('div'); opts.forEach((opt, idx) => { const id = `c_${field.key}_${idx}`; const labelEl = el('label', {}); const cb = el('input', { type: 'checkbox', id, value: opt }); cb.addEventListener('change', () => { const arr = qsa(`input[type="checkbox"][value]`).filter(i => i.checked && i.closest('.field') === fld).map(i => i.value); answers[field.key] = arr; postAutosaveDebounced(field.key, arr); updateSummaryUI() }); labelEl.appendChild(cb); labelEl.appendChild(document.createTextNode(' ' + opt)); group.appendChild(labelEl) }); controlBg.appendChild(group) } else if (field.type === 'textarea') { const ta = el('textarea', { rows: 4, name: field.key }); ta.addEventListener('change', () => { answers[field.key] = ta.value; postAutosaveDebounced(field.key, ta.value); updateSummaryUI() }); controlBg.appendChild(ta) } else if (field.type === 'number') {
                    const inp = el('input', {
                        type: 'text',
                        name: field.key,
                        inputmode: 'numeric',
                        pattern: '[0-9]*',
                        autocomplete: 'off'
                    });

                    inp.addEventListener('input', () => {
                        inp.value = inp.value.replace(/[^0-9.]/g, '');   // HARD strip letters
                        answers[field.key] = inp.value;
                        postAutosaveDebounced(field.key, inp.value);
                        updateSummaryUI();
                    });

                    controlBg.appendChild(inp);
                }
                if (field.category || field.price) controlBg.appendChild(el('div', { class: 'hint' }, [field.category, field.price ? 'price: ' + field.price : ''].filter(Boolean).join(' â€¢ '))); fld.appendChild(controlBg); grid.appendChild(fld)
            }); wrapper.appendChild(grid); updateSummaryUI()
        }
        let autosaveTimer = null; function postAutosaveDebounced(fieldName, fieldValue, extra = {}) { if (autosaveTimer) clearTimeout(autosaveTimer); autosaveTimer = setTimeout(() => { postJson(WEBAPP_URL, { sessionId, fieldName, fieldValue, ...extra }).catch(() => { }) }, 600) }
        async function loadConfigAndBuild() { try { const res = await fetchWithTimeout(WEBAPP_URL + '?_t=' + Date.now(), {}, 9000); const json = await res.json(); if (Array.isArray(json.ageTags)) mapAgeTagsFromJson(json.ageTags); if (json.cityMappings) { window.cityToState = json.cityMappings.cityToState || {} } if (json && json.status === 'ok' && Array.isArray(json.config)) { buildFormFromConfig(json.config) } else throw new Error('Invalid config') } catch (err) { qs('#formWrapper').innerHTML = '<div class="small-muted">Unable to load form configuration.</div>'; showMessage('Error loading form') } }
        function resetFormLocal() { for (const k in answers) delete answers[k]; qsa('input,textarea,select').forEach(i => { if (i.tagName === 'SELECT') i.selectedIndex = 0; else if (i.type === 'radio' || i.type === 'checkbox') i.checked = false; else i.value = '' }); updateSummaryUI(); showMessage('Form reset locally.'); setTimeout(clearMessage, 2000) }
        async function handleSubmit() { const submitBtn = qs('#submitBtn'); if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Submitting...' } try { configFields.forEach(f => { if (!f.key) return; const sel = qs(`select[name="${f.key}"]`); if (sel) answers[f.key] = sel.value; const inp = qs(`input[name="${f.key}"], textarea[name="${f.key}"]`); if (inp) answers[f.key] = inp.value }); await postJson(WEBAPP_URL, { sessionId, submitted: true, answers }, 10000, 2); qs('.left').innerHTML = ''; qs('.left').appendChild(el('div', { class: 'card' }, el('div', { style: 'text-align:center;padding:28px' }, el('h2', {}, 'Thanks! ðŸŽ‰'), el('div', { class: 'small-muted' }, 'We saved your picks.')))) } catch (err) { showMessage('Submission failed.'); if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Finish' } } }
        document.addEventListener('DOMContentLoaded', () => { qs('#submitBtn')?.addEventListener('click', handleSubmit); qs('#resetBtn')?.addEventListener('click', resetFormLocal); loadConfigAndBuild() })
    </script>
</body>

</html>