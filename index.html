<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Taste Buds Choices</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#ffecd2; --bg2:#fcb69f; --card:#ffffff; --accent:#f77f00; --muted:#6b7280; --title:#0d3b66;
    --radius:16px; --shadow:0 12px 40px rgba(13,59,102,0.12);
  }
  html,body{height:100%;margin:0;font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{
    display:flex;align-items:center;justify-content:center;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    padding:36px;
  }
  .app {
    width:100%;max-width:920px;background:var(--card);border-radius:var(--radius);
    box-shadow:var(--shadow);overflow:hidden;animation:cardIn .45s ease;
  }
  @keyframes cardIn{from{opacity:0;transform:translateY(18px) scale(.995)}to{opacity:1;transform:none}}
  header{padding:28px 32px 8px;background:linear-gradient(180deg,rgba(13,59,102,0.03),transparent);}
  h1{margin:0;font-size:28px;color:var(--title);text-align:center;font-weight:700;
      text-shadow:2px 2px 6px rgba(13,59,102,0.12);}
  .tagline{margin-top:8px;text-align:center;color:var(--muted);margin-bottom:8px;font-size:15px;line-height:1.35;
           text-shadow:0 2px 6px rgba(13,59,102,0.06);}
  main{padding:22px 32px 32px;}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;}
  .full{grid-column:1/-1}
  .field{background:#fbfdff;border-radius:12px;padding:12px;border:1px solid #eef2f7;display:flex;flex-direction:column;gap:8px;transition:transform .12s ease,box-shadow .12s ease}
  .field:focus-within{transform:translateY(-4px);box-shadow:0 8px 30px rgba(13,59,102,0.06)}
  label{font-weight:600;color:#1f2937;font-size:14px}
  select,input,textarea{font-size:15px;padding:10px;border-radius:10px;border:1px solid #d1d5db;background:white;outline:none}
  select:disabled,option[disabled]{color:#9ca3af}
  .hint{font-size:13px;color:var(--muted)}
  .state-line{font-weight:600;color:#374151;font-size:13px}
  .age-tagline{font-size:13px;color:#0d3b66;font-weight:600;margin-top:6px}
  .age-desc{font-size:13px;color:var(--muted);margin-top:4px}
  .controls{display:flex;gap:12px;align-items:center;justify-content:flex-end;margin-top:18px}
  button.primary{background:var(--accent);color:white;border:none;padding:12px 18px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 8px 20px rgba(247,127,0.12)}
  button.ghost{background:transparent;border:1px solid #e6e9ee;padding:10px 14px;border-radius:10px;cursor:pointer}
  .thanks{display:flex;flex-direction:column;align-items:center;gap:12px;padding:28px;text-align:center}
  .thanks h2{margin:0;color:var(--title)}
  .small-muted{font-size:13px;color:var(--muted)}
  .error{color:#b91c1c;font-weight:600}
  .loader{width:18px;height:18px;border-radius:50%;border:3px solid rgba(0,0,0,0.08);border-top-color:var(--accent);animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  @media (max-width:720px){.form-grid{grid-template-columns:1fr}.controls{flex-direction:column-reverse;align-items:stretch}}
</style>
</head>
<body>
  <div class="app" role="application" aria-labelledby="appTitle">
    <header>
      <h1 id="appTitle">Taste Buds Choices</h1>
      <div class="tagline">Pick your combo ‚Äì we‚Äôre dropping it near you.<br>Lock your picks and we will deliver vibes üòç</div>
    </header>

    <main>
      <div id="formArea" aria-live="polite">
        <div id="loading" class="small-muted" style="display:flex;align-items:center;gap:10px">
          <div class="loader" aria-hidden="true"></div>
          Loading form...
        </div>
      </div>

      <div class="controls" style="margin-top:18px">
        <button id="resetBtn" class="ghost" type="button" title="Reset form">Reset</button>
        <button id="submitBtn" class="primary" type="button" title="Finish">Finish</button>
      </div>

      <div id="message" style="margin-top:14px"></div>
    </main>
  </div>

<script>
/* WEBAPP URL (deployed Apps Script) */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyfgpiVmXrkVpi8GQ_4M6ZFQc7wMBSKExkppDLuOV2P09pCh1irhZnjU4DxlwuvASkA/exec";

/* Persistent sessionId */
let sessionId = localStorage.getItem("tb_session_id");
if (!sessionId) {
  sessionId = 's_' + Math.random().toString(36).slice(2,12);
  localStorage.setItem("tb_session_id", sessionId);
}
const answers = {};
let configFields = [];
let AGE_TAGS_MAP = {}; // key -> {displayLabel, tagline, description, responseTone}

/* City mappings (extend as needed) */
const cityToState = {
  "Ahmedabad":"Gujarat","Bengaluru":"Karnataka","Chennai":"Tamil Nadu","Coimbatore":"Tamil Nadu",
  "Delhi":"Delhi","Guwahati":"Assam","Hyderabad":"Telangana","Indore":"Madhya Pradesh",
  "Jaipur":"Rajasthan","Lucknow":"Uttar Pradesh","Mangaluru":"Karnataka","Mumbai":"Maharashtra",
  "Nagpur":"Maharashtra","Patna":"Bihar","Pune":"Maharashtra","Surat":"Gujarat",
  "Vadodara":"Gujarat","Visakhapatnam":"Andhra Pradesh","Vijayawada":"Andhra Pradesh","Kolkata":"West Bengal"
};
const cityToRegion = {
  "Ahmedabad":"West","Bengaluru":"South","Chennai":"South","Coimbatore":"South",
  "Delhi":"North","Guwahati":"Northeast","Hyderabad":"South","Indore":"Central",
  "Jaipur":"North","Lucknow":"North","Mangaluru":"South","Mumbai":"West",
  "Nagpur":"Central","Patna":"East","Pune":"West","Surat":"West",
  "Vadodara":"West","Visakhapatnam":"East","Vijayawada":"East","Kolkata":"East"
};

/* Helpers */
function el(tag, attrs = {}, ...children) {
  const node = document.createElement(tag);
  for (const k in attrs) {
    if (k === 'class') node.className = attrs[k];
    else if (k === 'html') node.innerHTML = attrs[k];
    else node.setAttribute(k, attrs[k]);
  }
  children.forEach(c => { if (c !== null && c !== undefined) node.appendChild(typeof c === 'string' ? document.createTextNode(c) : c); });
  return node;
}
function qs(sel, root = document) { return root.querySelector(sel); }
function qsa(sel, root = document) { return Array.from(root.querySelectorAll(sel)); }
function showMessage(text, type = 'info') {
  const msg = qs('#message');
  msg.innerHTML = '';
  const div = el('div', { class: type === 'error' ? 'error' : 'small-muted' }, text);
  msg.appendChild(div);
}
function clearMessage(){ qs('#message').innerHTML = ''; }

/* Network with timeout and retry */
async function fetchWithTimeout(url, opts = {}, timeout = 8000) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);
  try {
    const res = await fetch(url, { signal: controller.signal, ...opts });
    clearTimeout(id);
    return res;
  } catch (err) {
    clearTimeout(id);
    throw err;
  }
}
async function postJson(url, body, timeout = 8000, retries = 2) {
  const opts = { method: 'POST', body: JSON.stringify(body) };
  for (let i = 0; i <= retries; i++) {
    try {
      const r = await fetchWithTimeout(url, opts, timeout);
      if (!r.ok) throw new Error('Network response not ok: ' + r.status);
      return await r.json().catch(()=>({status:'ok'}));
    } catch (err) {
      if (i === retries) throw err;
      await new Promise(res => setTimeout(res, 400 * (i+1)));
    }
  }
}

/* Map AgeTags array into lookup */
function mapAgeTags(ageTagsArray) {
  AGE_TAGS_MAP = {};
  (ageTagsArray || []).forEach(r => {
    // Accept multiple possible header names
    const key = (r.key || r.Key || r.displayLabel || r.displaylabel || r.displayLabel || '').toString().trim();
    if (!key) return;
    AGE_TAGS_MAP[key] = {
      displayLabel: r.displayLabel || r.displaylabel || r.display || r.key || key,
      tagline: r.tagline || r.Tagline || r.description || '',
      description: r.description || r.Description || '',
      responseTone: r.responseTone || r.response_tone || ''
    };
  });
}

/* Build form from config */
function buildFormFromConfig(config) {
  configFields = config.map(c => {
    return {
      label: (c.label || c.Label || c.LABEL || c.key || '').toString(),
      type: (c.type || c.Type || c.TYPE || '').toString().toLowerCase(),
      key: (c.key || c.Key || c.KEY || c.label || '').toString(),
      options: (c.options || c.Options || c.OPTIONS || '').toString(),
      category: (c.category || c.Category || c.CATEGORY || '').toString(),
      price: (c.price || c.Price || c.PRICE || '').toString()
    };
  }).filter(f => f.key && f.label);

  const container = qs('#formArea');
  container.innerHTML = '';

  const grid = el('div', { class: 'form-grid' });
  container.appendChild(grid);

  configFields.forEach(field => {
    const wrapper = el('div', { class: 'field' });
    if (['textarea'].includes(field.type) || ['occupation','comments','feedback'].includes(field.key)) wrapper.classList.add('full');
    const label = el('label', {}, field.label);
    wrapper.appendChild(label);

    const attachAutosave = (inputEl, key) => {
      if (!inputEl) return;
      const save = (val, extra = {}) => {
        answers[key] = val;
        postAutosaveDebounced(key, val, extra);
      };
      if (inputEl.tagName === 'SELECT' || inputEl.type === 'checkbox' || inputEl.type === 'radio') {
        inputEl.addEventListener('change', () => {
          if (inputEl.type === 'checkbox') save(inputEl.checked);
          else save(inputEl.value);
        });
      } else {
        inputEl.addEventListener('blur', () => save(inputEl.value));
        inputEl.addEventListener('change', () => save(inputEl.value));
      }
    };

    if (field.type === 'select') {
      const sel = el('select');
      sel.name = field.key;
      const placeholder = el('option', { value: '', disabled: true, selected: true }, 'Select');
      sel.appendChild(placeholder);
      if (field.options) {
        field.options.split(/;|,/).map(s => s.trim()).filter(Boolean).forEach(opt => {
          sel.appendChild(el('option', { value: opt }, opt));
        });
      }
      if (field.key.toLowerCase().includes('city')) {
        const stateLine = el('div', { class: 'state-line' }, '');
        sel.addEventListener('change', () => {
          const city = sel.value;
          const state = cityToState[city] || '';
          const region = cityToRegion[city] || '';
          if (state) stateLine.textContent = `State: ${state} | Region: ${region}`;
          const ph = sel.querySelector('option[value=""]');
          if (ph) ph.remove();
          postAutosaveDebounced(field.key, city, { state, region });
          answers[field.key] = city;
          answers.state = state;
          answers.region = region;
        });
        wrapper.appendChild(sel);
        wrapper.appendChild(stateLine);
      } else {
        sel.addEventListener('change', () => {
          const ph = sel.querySelector('option[value=""]');
          if (ph) ph.remove();
        });
        wrapper.appendChild(sel);
        attachAutosave(sel, field.key);
      }
    }
    else if (field.type === 'radio') {
      const opts = field.options ? field.options.split(/;|,/).map(s => s.trim()).filter(Boolean) : [];
      const group = el('div', {});
      opts.forEach((opt, idx) => {
        const id = `r_${field.key}_${idx}`;
        const labelEl = el('label', {});
        const radio = el('input', { type: 'radio', name: field.key, id, value: opt });
        radio.addEventListener('change', () => {
          answers[field.key] = opt;
          postAutosaveDebounced(field.key, opt);
        });
        labelEl.appendChild(radio);
        labelEl.appendChild(document.createTextNode(' ' + opt));
        group.appendChild(labelEl);
      });
      wrapper.appendChild(group);
    }
    else if (field.type === 'checkbox') {
      const opts = field.options ? field.options.split(/;|,/).map(s => s.trim()).filter(Boolean) : [];
      const group = el('div', {});
      opts.forEach((opt, idx) => {
        const id = `c_${field.key}_${idx}`;
        const labelEl = el('label', {});
        const cb = el('input', { type: 'checkbox', id, value: opt });
        cb.addEventListener('change', () => {
          const arr = qsa(`input[type="checkbox"][value]`).filter(i => i.checked && i.closest('.field') === wrapper).map(i => i.value);
          answers[field.key] = arr;
          postAutosaveDebounced(field.key, arr);
        });
        labelEl.appendChild(cb);
        labelEl.appendChild(document.createTextNode(' ' + opt));
        group.appendChild(labelEl);
      });
      wrapper.appendChild(group);
    }
    else if (field.type === 'textarea') {
      const ta = el('textarea', { rows: 4, name: field.key });
      wrapper.appendChild(ta);
      attachAutosave(ta, field.key);
    }
    else {
      const inp = el('input', { type: 'text', name: field.key, autocomplete: 'off' });
      wrapper.appendChild(inp);
      attachAutosave(inp, field.key);
    }

    const hintParts = [];
    if (field.category) hintParts.push(field.category);
    if (field.price) hintParts.push('price: ' + field.price);
    if (hintParts.length) wrapper.appendChild(el('div', { class: 'hint' }, hintParts.join(' ‚Ä¢ ')));

    grid.appendChild(wrapper);
  });

  const footerNote = el('div', { class: 'full' }, el('div', { class: 'small-muted' }, 'Yesterday\'s taglines: "Pick your combo" ‚Ä¢ "Lock your picks and we will deliver vibes"'));
  grid.appendChild(footerNote);
}

/* Autosave debounce */
let autosaveTimer = null;
const AUTOSAVE_DELAY = 600;
function postAutosaveDebounced(fieldName, fieldValue, extra = {}) {
  if (autosaveTimer) clearTimeout(autosaveTimer);
  autosaveTimer = setTimeout(() => {
    const payload = { sessionId, fieldName, fieldValue, ...extra };
    postJson(WEBAPP_URL, payload, 7000, 1).catch(err => {
      console.warn('Autosave failed', err);
      showMessage('Autosave temporarily failed. Changes will retry on submit.', 'error');
      setTimeout(clearMessage, 4000);
    });
  }, AUTOSAVE_DELAY);
}

/* Load config (doGet) and ageTags, then build form and attach age tagline behavior */
async function loadConfigAndBuild() {
  const loading = qs('#loading');
  loading.style.display = 'flex';
  try {
    const res = await fetchWithTimeout(WEBAPP_URL, {}, 9000);
    const json = await res.json();
    if (json && json.status === 'ok' && Array.isArray(json.config)) {
      // map ageTags if present
      if (Array.isArray(json.ageTags)) {
        mapAgeTags(json.ageTags);
      } else {
        // also accept ageTags under different key names
        if (json.ageTagsArray) mapAgeTags(json.ageTagsArray);
      }
      buildFormFromConfig(json.config);
      // attach age tagline behavior after form is built
      attachAgeTaglineBehavior();
      clearMessage();
    } else {
      throw new Error('Invalid config response');
    }
  } catch (err) {
    console.error('Failed to load config', err);
    const container = qs('#formArea');
    container.innerHTML = '';
    container.appendChild(el('div', { class: 'error' }, 'Unable to load form configuration. Check the Config and AgeTags sheets and Apps Script deployment.'));
    showMessage('Error loading form. Make sure the Apps Script is deployed and the WEBAPP_URL is correct.', 'error');
  } finally {
    loading.style.display = 'none';
  }
}

/* Attach age select change behavior to show tagline + description */
function attachAgeTaglineBehavior() {
  // find the age select by name or label
  const ageSelect = document.querySelector('select[name="ageGroup"]') ||
    Array.from(document.querySelectorAll('select')).find(s => s.previousSibling && s.previousSibling.textContent && s.previousSibling.textContent.toLowerCase().includes('age'));
  if (!ageSelect) return;

  // create display nodes (insert after select)
  let tagNode = el('div', { class: 'age-tagline' }, '');
  let descNode = el('div', { class: 'age-desc' }, '');
  // ensure we don't duplicate nodes if re-attaching
  const parent = ageSelect.parentNode;
  // remove existing if present
  const existingTag = parent.querySelector('.age-tagline');
  if (existingTag) existingTag.remove();
  const existingDesc = parent.querySelector('.age-desc');
  if (existingDesc) existingDesc.remove();

  parent.appendChild(tagNode);
  parent.appendChild(descNode);

  ageSelect.addEventListener('change', () => {
    const val = ageSelect.value;
    const info = AGE_TAGS_MAP[val] || AGE_TAGS_MAP[val.trim()] || null;
    if (info) {
      tagNode.textContent = info.tagline || info.displayLabel || '';
      descNode.textContent = info.description || info.responseTone || '';
    } else {
      tagNode.textContent = '';
      descNode.textContent = '';
    }
  });

  // if there's a preselected value, trigger once
  if (ageSelect.value) {
    const ev = new Event('change');
    ageSelect.dispatchEvent(ev);
  }
}

/* Final submit */
async function handleSubmit() {
  const submitBtn = qs('#submitBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Submitting...';
  try {
    configFields.forEach(f => {
      if (!f.key) return;
      const name = f.key;
      if (f.type === 'radio') {
        const checked = qsa(`input[type="radio"][name="${name}"]`).find(i => i.checked);
        if (checked) answers[name] = checked.value;
      } else if (f.type === 'checkbox') {
        const checked = qsa(`input[type="checkbox"]`).filter(i => i.checked && i.closest('.field'));
        answers[name] = checked.map(i => i.value);
      } else if (f.type === 'select') {
        const sel = qsa('select').find(s => s.name === name || (s.closest('.field') && s.previousSibling && s.previousSibling.textContent === f.label));
        if (sel) answers[name] = sel.value;
      } else {
        const inp = qsa('input,textarea').find(i => i.name === name || (i.closest('.field') && i.previousSibling && i.previousSibling.textContent === f.label));
        if (inp) answers[name] = inp.value;
      }
    });

    const payload = { sessionId, submitted: true, answers };
    await postJson(WEBAPP_URL, payload, 10000, 2);

    const main = qs('main');
    main.innerHTML = '';
    const thanks = el('div', { class: 'thanks' },
      el('h2', {}, 'Thanks for completing Taste Buds Choices! üéâ'),
      el('div', { class: 'small-muted' }, 'We saved your picks. You can close this window now.'),
      el('button', { class: 'primary', onclick: 'window.location.reload()' }, 'Done')
    );
    main.appendChild(thanks);
  } catch (err) {
    console.error('Submit failed', err);
    showMessage('Submission failed. Please check your connection and try again.', 'error');
    submitBtn.disabled = false;
    submitBtn.textContent = 'Finish';
  }
}

/* Reset local form */
function resetFormLocal() {
  for (const k in answers) delete answers[k];
  qsa('input,textarea,select').forEach(i => {
    if (i.tagName === 'SELECT') i.selectedIndex = 0;
    else if (i.type === 'radio' || i.type === 'checkbox') i.checked = false;
    else i.value = '';
  });
  showMessage('Form reset locally. Autosaved rows remain in Responses sheet.', 'info');
  setTimeout(clearMessage, 3000);
}

/* Init */
document.addEventListener('DOMContentLoaded', () => {
  qs('#submitBtn').addEventListener('click', handleSubmit);
  qs('#resetBtn').addEventListener('click', resetFormLocal);
  loadConfigAndBuild();
});
</script>
</body>
</html>
