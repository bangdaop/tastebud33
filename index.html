<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Taste Buds Choices</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#fff7ed; --bg2:#fff1e6; --card:#ffffff; --accent:#ff7a00; --accent-2:#0d3b66;
    --muted:#6b7280; --radius:12px; --shadow:0 14px 40px rgba(13,59,102,0.08);
    --gap:14px;
  }
  html,body{height:100%;margin:0;font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#111827;background:linear-gradient(135deg,var(--bg1),var(--bg2));-webkit-font-smoothing:antialiased}
  .app{max-width:980px;margin:20px auto;border-radius:16px;overflow:hidden;box-shadow:var(--shadow);background:linear-gradient(180deg,#fff,#fbfbff);border:1px solid rgba(13,59,102,0.04)}
  header{position:relative;padding:22px 20px 28px;text-align:center;color:#fff;background-color: rgba(13,59,102,0.12);overflow:visible}
  header::before{content:"";position:absolute;inset:0;z-index:0;background-image:linear-gradient(rgba(13,59,102,0.28), rgba(13,59,102,0.18)),url('https://drive.google.com/uc?export=view&id=1rGPIGyEijiSivuAFZ5O_1fqRi6a_Jtus');background-size:cover;background-position:center;filter:saturate(0.95) contrast(0.95);-webkit-mask-image:radial-gradient(ellipse at center, rgba(0,0,0,1) 62%, rgba(0,0,0,0) 100%);mask-image:radial-gradient(ellipse at center, rgba(0,0,0,1) 62%, rgba(0,0,0,0) 100%);-webkit-mask-size:120% 120%;mask-size:120% 120%;pointer-events:none}
  header .content{position:relative;z-index:2}
  h1{margin:0;font-size:22px;color:#fff;font-weight:700;text-shadow:0 6px 18px rgba(0,0,0,0.28)}
  .tagline{margin-top:8px;color:rgba(255,255,255,0.95);font-size:13px;line-height:1.3}
  main{display:flex;gap:var(--gap);padding:16px}
  .left{flex:1;min-width:0}
  .card{background:var(--card);border-radius:12px;padding:12px;border:1px solid rgba(13,59,102,0.03)}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .field{display:flex;flex-direction:column;gap:8px;margin-bottom:6px}
  label{font-weight:600;color:#0f172a;font-size:13px}
  select,input,textarea{font-size:15px;padding:10px;border-radius:10px;border:1px solid #e6eef6;background:#fff;outline:none}
  select:focus,input:focus,textarea:focus{box-shadow:0 8px 22px rgba(13,59,102,0.06);border-color:var(--accent)}
  .hint{font-size:12px;color:var(--muted)}
  .age-panel{margin-top:8px;padding:10px;border-radius:10px;background:linear-gradient(180deg,#fff,#fcfcff);border:1px solid rgba(13,59,102,0.03)}
  .age-tagline{font-weight:700;color:var(--accent-2);font-size:14px}
  .summary{margin-top:12px;display:flex;flex-direction:column;gap:8px}
  .summary-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:linear-gradient(180deg,#fff,#fbfbff);border:1px solid rgba(13,59,102,0.03);font-size:13px}
  .controls{display:flex;gap:12px;justify-content:flex-end;margin-top:14px}
  .btn-primary{background:linear-gradient(180deg,var(--accent),#d95b00);color:white;border:none;padding:12px 18px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 8px 24px rgba(255,122,0,0.12)}
  .btn-secondary{background:transparent;border:1px solid #e6eef6;padding:10px 14px;border-radius:10px;cursor:pointer}
  .small-muted{font-size:13px;color:var(--muted)}
  .loader{width:16px;height:16px;border-radius:50%;border:3px solid rgba(0,0,0,0.06);border-top-color:var(--accent);animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .sidebar{width:320px;display:flex;flex-direction:column;gap:12px}
  .sidebar .card{padding:12px}
  @media (max-width:820px){
    main{flex-direction:column;padding:12px}
    .form-grid{grid-template-columns:1fr}
    .sidebar{display:none}
    .controls{display:none}
    .app{margin:8px}
    header{padding:18px}
    header::before{-webkit-mask-image:radial-gradient(ellipse at center, rgba(0,0,0,1) 72%, rgba(0,0,0,0) 100%);mask-image:radial-gradient(ellipse at center, rgba(0,0,0,1) 72%, rgba(0,0,0,0) 100%)}
  }
  .mobile-bar{display:none;position:fixed;left:0;right:0;bottom:0;padding:10px;background:linear-gradient(180deg,#fff,#fff);box-shadow:0 -6px 20px rgba(13,59,102,0.06);border-top:1px solid rgba(13,59,102,0.04);z-index:60}
  .mobile-bar .bar-inner{max-width:980px;margin:0 auto;display:flex;gap:10px;justify-content:space-between;padding:6px}
  .mobile-bar .btn-primary{flex:1;padding:12px;border-radius:10px}
  .mobile-bar .btn-secondary{padding:10px 12px;border-radius:10px}
  @media (max-width:820px){ .mobile-bar{display:block} }
  select option{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
</style>
</head>
<body>
  <div class="app" role="application" aria-labelledby="appTitle">
    <header>
      <div class="content">
        <h1 id="appTitle">Taste Buds Choices</h1>
        <div class="tagline">Pick your combo â€” weâ€™ll drop it near you. Lock your picks and weâ€™ll deliver vibes.</div>
      </div>
    </header>

    <main>
      <div class="left">
        <div id="formArea" class="card" aria-live="polite">
          <div id="loading" style="display:flex;align-items:center;gap:10px">
            <div class="loader" aria-hidden="true"></div>
            <div class="small-muted">Loading formâ€¦</div>
          </div>
        </div>

        <div class="controls" style="margin-top:12px">
          <button id="resetBtn" class="btn-secondary" type="button" title="Reset form">Reset</button>
          <button id="submitBtn" class="btn-primary" type="button" title="Finish">Finish</button>
        </div>

        <div id="message" style="margin-top:12px"></div>
      </div>

      <aside class="sidebar">
        <div class="card">
          <div style="font-weight:700;margin-bottom:6px">Your quick summary</div>
          <div class="small-muted" id="sessionIdDisplay" style="margin-bottom:8px"></div>
          <div id="summaryList" style="display:flex;flex-direction:column;gap:8px"></div>
          <div class="small-muted" style="font-size:12px;margin-top:8px">Autosaves as you interact.</div>
        </div>
      </aside>
    </main>
  </div>

  <div class="mobile-bar" role="toolbar" aria-hidden="false">
    <div class="bar-inner">
      <button id="resetBtnMobile" class="btn-secondary" type="button">Reset</button>
      <button id="submitBtnMobile" class="btn-primary" type="button">Finish</button>
    </div>
  </div>

<script>
/* WEBAPP URL */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwAn--D_OWt4uFwJV6zn-EiilyOgnFNNuenusA3UwBj2HU81vRtZiwrAQ2G5mH9U-Q/exec";

/* session */
let sessionId = localStorage.getItem("tb_session_id");
if (!sessionId) {
  sessionId = 's_' + Math.random().toString(36).slice(2,12);
  localStorage.setItem("tb_session_id", sessionId);
}
document.getElementById('sessionIdDisplay').textContent = sessionId;

const answers = {};
let configFields = [];
let AGE_TAGS_MAP = {}; // normalizedKey -> { displayLabel }

/* Normalization helpers */
function normalizeKey(s) {
  if (!s && s !== 0) return '';
  let t = String(s);
  t = t.replace(/[\u200B-\u200F\uFEFF]/g, '');
  t = t.replace(/[\u2012\u2013\u2014\u2015]/g, '-');
  t = t.replace(/\s+/g, ' ').trim();
  return t.toLowerCase();
}
function stripEmoji(s) {
  if (!s) return s;
  return s.replace(/[\u{1F300}-\u{1F6FF}\u{1F900}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, '').trim();
}

/* Map AgeTags into lookup using normalized keys */
function mapAgeTags(ageTagsArray) {
  AGE_TAGS_MAP = {};
  (ageTagsArray || []).forEach(r => {
    const rawKey = (r.key || r.Key || '').toString().trim();
    const display = (r.displayLabel || r.displaylabel || r.display || '').toString().trim();
    if (!rawKey) return;
    const n = normalizeKey(rawKey);
    AGE_TAGS_MAP[n] = { displayLabel: display || rawKey };
    const stripped = normalizeKey(stripEmoji(rawKey));
    if (stripped && stripped !== n) AGE_TAGS_MAP[stripped] = AGE_TAGS_MAP[n];
  });
}

/* DOM helpers */
function el(tag, attrs = {}, ...children) {
  const node = document.createElement(tag);
  for (const k in attrs) {
    if (k === 'class') node.className = attrs[k];
    else if (k === 'html') node.innerHTML = attrs[k];
    else node.setAttribute(k, attrs[k]);
  }
  children.forEach(c => { if (c !== null && c !== undefined) node.appendChild(typeof c === 'string' ? document.createTextNode(c) : c); });
  return node;
}
function qs(sel, root = document) { return root.querySelector(sel); }
function qsa(sel, root = document) { return Array.from(root.querySelectorAll(sel)); }
function showMessage(text, type = 'info') {
  const msg = qs('#message'); msg.innerHTML = '';
  const div = el('div', { class: type === 'error' ? 'error' : 'small-muted' }, text);
  msg.appendChild(div);
}
function clearMessage(){ qs('#message').innerHTML = ''; }

/* network */
async function fetchWithTimeout(url, opts = {}, timeout = 9000) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);
  try {
    const res = await fetch(url, { signal: controller.signal, ...opts });
    clearTimeout(id);
    return res;
  } catch (err) { clearTimeout(id); throw err; }
}
async function postJson(url, body, timeout = 9000, retries = 2) {
  const opts = { method: 'POST', body: JSON.stringify(body) };
  for (let i = 0; i <= retries; i++) {
    try {
      const r = await fetchWithTimeout(url, opts, timeout);
      if (!r.ok) throw new Error('Network response not ok: ' + r.status);
      return await r.json().catch(()=>({status:'ok'}));
    } catch (err) {
      if (i === retries) throw err;
      await new Promise(res => setTimeout(res, 300 * (i+1)));
    }
  }
}

/* Build form from config */
function buildFormFromConfig(config) {
  configFields = config.map(c => {
    return {
      label: (c.label || c.Label || c.LABEL || c.key || '').toString(),
      type: (c.type || c.Type || c.TYPE || '').toString().toLowerCase(),
      key: (c.key || c.Key || c.KEY || c.label || '').toString(),
      options: (c.options || c.Options || c.OPTIONS || '').toString(),
      category: (c.category || c.Category || c.CATEGORY || '').toString(),
      price: (c.price || c.Price || c.PRICE || '').toString()
    };
  }).filter(f => f.key && f.label);

  const container = qs('#formArea');
  container.innerHTML = '';
  const grid = el('div', { class: 'form-grid' });
  container.appendChild(grid);

  configFields.forEach(field => {
    const wrapper = el('div', { class: 'field' });
    const label = el('label', {}, field.label);
    wrapper.appendChild(label);

    const attachAutosave = (inputEl, key) => {
      if (!inputEl) return;
      const save = (val, extra = {}) => {
        answers[key] = val;
        postAutosaveDebounced(key, val, extra);
        updateSummaryUI();
      };
      if (inputEl.tagName === 'SELECT' || inputEl.type === 'checkbox' || inputEl.type === 'radio') {
        inputEl.addEventListener('change', () => {
          if (inputEl.type === 'checkbox') save(inputEl.checked);
          else save(inputEl.value);
        });
      } else {
        inputEl.addEventListener('blur', () => save(inputEl.value));
        inputEl.addEventListener('change', () => save(inputEl.value));
      }
    };

    if (field.type === 'select') {
      const sel = el('select'); sel.name = field.key;
      const placeholder = el('option', { value: '', disabled: true, selected: true }, 'Select');
      sel.appendChild(placeholder);

      const rawOpts = field.options ? field.options.split(/;|,/).map(s => s.trim()).filter(Boolean) : [];

      if (String(field.key).toLowerCase().indexOf('age') !== -1 && rawOpts.length) {
        rawOpts.forEach(opt => {
          const n = normalizeKey(opt);
          const strippedN = normalizeKey(stripEmoji(opt));
          const info = AGE_TAGS_MAP[n] || AGE_TAGS_MAP[strippedN] || null;
          const displayText = (info && info.displayLabel) ? info.displayLabel : opt;
          // store original in data-original, and data-display for label
          const optionEl = el('option', { value: opt, 'data-original': opt, 'data-display': displayText }, opt);
          sel.appendChild(optionEl);
        });

        // When user opens the select, restore original option texts
        sel.addEventListener('mousedown', () => {
          qsa(`select[name="${field.key}"] option`).forEach(o => {
            const orig = o.getAttribute('data-original');
            if (orig) o.textContent = orig;
          });
        });

        // On change, replace selected option text with displayLabel
        sel.addEventListener('change', () => {
          const val = sel.value;
          const opt = sel.querySelector(`option[value="${CSS.escape(val)}"]`);
          if (!opt) return;
          const n = normalizeKey(val);
          const stripped = normalizeKey(stripEmoji(val));
          const info = AGE_TAGS_MAP[n] || AGE_TAGS_MAP[stripped] || null;
          const display = (info && info.displayLabel) ? info.displayLabel : (opt.getAttribute('data-display') || val);
          // set selected option text to display label
          opt.textContent = display;
          // ensure other options keep their original text
          qsa(`select[name="${field.key}"] option`).forEach(o => {
            if (o !== opt) {
              const orig = o.getAttribute('data-original');
              if (orig) o.textContent = orig;
            }
          });
          // autosave and UI update
          const state = (window.cityToState && window.cityToState[answers.city]) || '';
          const region = (window.cityToRegion && window.cityToRegion[answers.city]) || '';
          postAutosaveDebounced(field.key, val, { state, region });
          answers[field.key] = val;
          updateSummaryUI();
        });
      }
      else if (String(field.key).toLowerCase().indexOf('city') !== -1 && rawOpts.length) {
        rawOpts.sort((a,b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
        rawOpts.forEach(opt => sel.appendChild(el('option', { value: opt }, opt)));
        sel.addEventListener('change', () => {
          const city = sel.value;
          const state = (window.cityToState && window.cityToState[city]) || '';
          const region = (window.cityToRegion && window.cityToRegion[city]) || '';
          postAutosaveDebounced(field.key, city, { state, region });
          answers[field.key] = city; answers.state = state; answers.region = region;
          updateSummaryUI();
        });
      }
      else {
        rawOpts.forEach(opt => sel.appendChild(el('option', { value: opt }, opt)));
        attachAutosave(sel, field.key);
      }

      wrapper.appendChild(sel);
    }
    else if (field.type === 'radio') {
      const opts = field.options ? field.options.split(/;|,/).map(s => s.trim()).filter(Boolean) : [];
      const group = el('div', {});
      opts.forEach((opt, idx) => {
        const id = `r_${field.key}_${idx}`;
        const labelEl = el('label', {});
        const radio = el('input', { type: 'radio', name: field.key, id, value: opt });
        radio.addEventListener('change', () => {
          answers[field.key] = opt; postAutosaveDebounced(field.key, opt); updateSummaryUI();
        });
        labelEl.appendChild(radio); labelEl.appendChild(document.createTextNode(' ' + opt));
        group.appendChild(labelEl);
      });
      wrapper.appendChild(group);
    }
    else if (field.type === 'checkbox') {
      const opts = field.options ? field.options.split(/;|,/).map(s => s.trim()).filter(Boolean) : [];
      const group = el('div', {});
      opts.forEach((opt, idx) => {
        const id = `c_${field.key}_${idx}`;
        const labelEl = el('label', {});
        const cb = el('input', { type: 'checkbox', id, value: opt });
        cb.addEventListener('change', () => {
          const arr = qsa(`input[type="checkbox"][value]`).filter(i => i.checked && i.closest('.field') === wrapper).map(i => i.value);
          answers[field.key] = arr; postAutosaveDebounced(field.key, arr); updateSummaryUI();
        });
        labelEl.appendChild(cb); labelEl.appendChild(document.createTextNode(' ' + opt));
        group.appendChild(labelEl);
      });
      wrapper.appendChild(group);
    }
    else if (field.type === 'textarea') {
      const ta = el('textarea', { rows: 4, name: field.key });
      wrapper.appendChild(ta); attachAutosave(ta, field.key);
    }
    else {
      const inp = el('input', { type: 'text', name: field.key, autocomplete: 'off' });
      wrapper.appendChild(inp); attachAutosave(inp, field.key);
    }

    const hintParts = [];
    if (field.category) hintParts.push(field.category);
    if (field.price) hintParts.push('price: ' + field.price);
    if (hintParts.length) wrapper.appendChild(el('div', { class: 'hint' }, hintParts.join(' â€¢ ')));

    grid.appendChild(wrapper);
  });

  container.appendChild(grid);
  attachAgeTaglineBehavior();
  updateSummaryUI();
}

/* autosave debounce */
let autosaveTimer = null;
const AUTOSAVE_DELAY = 600;
function postAutosaveDebounced(fieldName, fieldValue, extra = {}) {
  if (autosaveTimer) clearTimeout(autosaveTimer);
  autosaveTimer = setTimeout(() => {
    const payload = { sessionId, fieldName, fieldValue, ...extra };
    postJson(WEBAPP_URL, payload, 7000, 1).catch(err => {
      console.warn('Autosave failed', err);
      showMessage('Autosave temporarily failed. Changes will retry on submit.', 'error');
      setTimeout(clearMessage, 4000);
    });
  }, AUTOSAVE_DELAY);
}

/* load config and ageTags */
async function loadConfigAndBuild() {
  const loading = qs('#loading'); loading.style.display = 'flex';
  try {
    const res = await fetchWithTimeout(WEBAPP_URL + '?_t=' + Date.now(), {}, 9000);
    const json = await res.json();
    if (json && json.status === 'ok' && Array.isArray(json.config)) {
      if (Array.isArray(json.ageTags)) mapAgeTags(json.ageTags);
      buildFormFromConfig(json.config);
      clearMessage();
    } else {
      throw new Error('Invalid config response');
    }
  } catch (err) {
    console.error('Failed to load config', err);
    const container = qs('#formArea'); container.innerHTML = '';
    container.appendChild(el('div', { class: 'small-muted' }, 'Unable to load form configuration. Check Config and AgeTags sheets and Apps Script deployment.'));
    showMessage('Error loading form. Confirm the web app URL and that the script is deployed with correct access.', 'error');
  } finally {
    loading.style.display = 'none';
  }
}

/* age tagline UI (shows displayLabel after selection) */
function attachAgeTaglineBehavior() {
  const ageSelect = document.querySelector('select[name="ageGroup"]') ||
    Array.from(document.querySelectorAll('select')).find(s => s.previousSibling && s.previousSibling.textContent && s.previousSibling.textContent.toLowerCase().includes('age'));
  if (!ageSelect) return;

  let panel = ageSelect.parentNode.querySelector('.age-panel');
  if (!panel) {
    panel = el('div', { class: 'age-panel' });
    ageSelect.parentNode.appendChild(panel);
  }
  panel.innerHTML = '';
  const tagNode = el('div', { class: 'age-tagline' }, '');
  panel.appendChild(tagNode);

  ageSelect.addEventListener('change', () => {
    const val = ageSelect.value;
    const n = normalizeKey(val);
    const stripped = normalizeKey(stripEmoji(val));
    const info = AGE_TAGS_MAP[n] || AGE_TAGS_MAP[stripped] || null;
    if (info) tagNode.textContent = info.displayLabel || val;
    else {
      const opt = ageSelect.querySelector(`option[value="${CSS.escape(val)}"]`);
      tagNode.textContent = (opt && opt.getAttribute('data-display')) ? opt.getAttribute('data-display') : val;
    }
  });

  if (ageSelect.value) ageSelect.dispatchEvent(new Event('change'));
}

/* summary UI */
function updateSummaryUI() {
  const list = qs('#summaryList'); list.innerHTML = '';
  const keys = Object.keys(answers);
  if (keys.length === 0) {
    list.appendChild(el('div', { class: 'small-muted' }, 'No selections yet'));
    return;
  }
  keys.slice(0, 8).forEach(k => {
    const v = answers[k];
    const row = el('div', { class: 'summary-row' },
      el('div', {}, k),
      el('div', {}, (Array.isArray(v) ? v.join(', ') : (v === '' || v === null ? 'â€”' : String(v))))
    );
    list.appendChild(row);
  });
}

/* final submit */
async function handleSubmit() {
  const submitBtn = qs('#submitBtn') || qs('#submitBtnMobile');
  if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Submitting...'; }
  try {
    configFields.forEach(f => {
      if (!f.key) return;
      const name = f.key;
      if (f.type === 'radio') {
        const checked = qsa(`input[type="radio"][name="${name}"]`).find(i => i.checked);
        if (checked) answers[name] = checked.value;
      } else if (f.type === 'checkbox') {
        const checked = qsa(`input[type="checkbox"]`).filter(i => i.checked && i.closest('.field'));
        answers[name] = checked.map(i => i.value);
      } else if (f.type === 'select') {
        const sel = qsa('select').find(s => s.name === name);
        if (sel) answers[name] = sel.value;
      } else {
        const inp = qsa('input,textarea').find(i => i.name === name);
        if (inp) answers[name] = inp.value;
      }
    });

    const payload = { sessionId, submitted: true, answers };
    await postJson(WEBAPP_URL, payload, 10000, 2);

    const left = qs('.left'); left.innerHTML = '';
    left.appendChild(el('div', { class: 'card' },
      el('div', { style: 'text-align:center;padding:28px' },
        el('h2', {}, 'Thanks! ðŸŽ‰'),
        el('div', { class: 'small-muted' }, 'We saved your picks. You can close this window.'),
        el('div', { style: 'margin-top:12px' }, el('button', { class: 'btn-primary', onclick: 'window.location.reload()' }, 'Done'))
      )
    ));
  } catch (err) {
    console.error('Submit failed', err);
    showMessage('Submission failed. Check connection and try again.', 'error');
    if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Finish'; }
  }
}

/* reset */
function resetFormLocal() {
  for (const k in answers) delete answers[k];
  qsa('input,textarea,select').forEach(i => {
    if (i.tagName === 'SELECT') i.selectedIndex = 0;
    else if (i.type === 'radio' || i.type === 'checkbox') i.checked = false;
    else i.value = '';
  });
  updateSummaryUI();
  showMessage('Form reset locally.', 'info');
  setTimeout(clearMessage, 2000);
}

/* wire mobile buttons */
document.addEventListener('DOMContentLoaded', () => {
  qs('#submitBtn')?.addEventListener('click', handleSubmit);
  qs('#resetBtn')?.addEventListener('click', resetFormLocal);
  qs('#submitBtnMobile')?.addEventListener('click', handleSubmit);
  qs('#resetBtnMobile')?.addEventListener('click', resetFormLocal);
  loadConfigAndBuild();
});
</script>
</body>
</html>
