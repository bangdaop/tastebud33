<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Taste Buds Choices</title>

    <style>
        body {
            margin: 0;
            font-family: Arial;
            background: #f6f8fa;
        }

        .container {
            max-width: 760px;
            margin: auto;
            padding: 12px;
        }

        .header img {
            width: 100%;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .card {
            background: white;
            padding: 14px;
            border-radius: 12px;
            margin-bottom: 14px;
            box-shadow: 0 4px 14px rgba(0, 0, 0, .06);
        }

        label {
            font-weight: 600;
            display: block;
            margin-bottom: 6px;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 15px;
        }

        .radio label {
            display: block;
            margin: 6px 0;
            font-weight: 400;
        }

        #loadWrap {
            margin: 10px 0;
            text-align: center;
        }

        #loadTrack {
            height: 6px;
            background: #ddd;
            border-radius: 6px;
            overflow: hidden;
        }

        #loadBar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ff7a00, #ffb347);
            transition: .3s;
        }

        #surveyBar {
            height: 6px;
            background: #ddd;
            border-radius: 6px;
            overflow: hidden;
            margin: 12px 0;
        }

        #surveyBarInner {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #0d3b66, #3fa9f5);
            transition: .3s;
        }

        button {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: none;
            background: #ff7a00;
            color: white;
            font-weight: 700;
            margin-top: 10px;
        }

        button:disabled {
            opacity: .4
        }

        #thanks {
            text-align: center;
            font-size: 20px;
            padding: 40px;
        }

        @media(max-width:600px) {
            .container {
                padding: 8px
            }
        }
    </style>
</head>

<body>

    <div class="container">

        <div class="header">
            <img src="https://raw.githubusercontent.com/bangdaop/33cimg/main/photo_6062312442882100596_y.jpg">
        </div>

        <div id="loadWrap">
            <div id="loadTrack">
                <div id="loadBar"></div>
            </div>
            <div id="loadText">Loading‚Ä¶</div>
        </div>

        <div id="surveyBar">
            <div id="surveyBarInner"></div>
        </div>

        <div id="formWrapper"></div>

        <button id="submitBtn" disabled>Finish</button>

        <div id="thanks" style="display:none">üôè Thanks! Your response is saved.</div>

    </div>

    <script>
        const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwxz9H-DUWMsQy2bD7nrf6NEGizKwN4E8PU3GWplO7Z9pk81wiRh90IGkBmVW9OJSEV/exec";

        let sessionId = localStorage.getItem("tb_session_id");
        if (!sessionId) {
            sessionId = 's_' + Math.random().toString(36).slice(2, 12);
            localStorage.setItem("tb_session_id", sessionId);
        }

        const answers = {}
        let configFields = []

        function qs(x) { return document.querySelector(x) }
        function el(t, a = {}, ...c) {
            const n = document.createElement(t)
            for (const k in a) n.setAttribute(k, a[k])
            c.forEach(x => n.append(x))
            return n
        }

        function setLoad(p) {
            qs('#loadBar').style.width = p + '%'
            qs('#loadText').innerText = 'Loading ' + p + '%'
        }

        function updateSurveyProgress() {
            let done = 0
            configFields.forEach(f => {
                const v = answers[f.key]
                if (v !== undefined && v !== '') done++
            })
            const pct = Math.round(done / configFields.length * 100)
            qs('#surveyBarInner').style.width = pct + '%'
            qs('#submitBtn').disabled = done !== configFields.length
        }

        function autosave(k, v) {
            fetch(WEBAPP_URL, {
                method: 'POST',
                body: JSON.stringify({ sessionId, fieldName: k, fieldValue: v })
            }).catch(() => { })
        }

        async function loadConfigAndBuild() {
            try {
                setLoad(20)
                const r = await fetch(WEBAPP_URL)
                setLoad(60)
                const j = await r.json()
                configFields = j.config || []
                setLoad(90)
                buildForm()
                updateSurveyProgress()
                setTimeout(() => qs('#loadWrap').style.display = 'none', 400)
            } catch (e) {
                qs('#formWrapper').innerText = 'Failed loading form'
            }
        }

        function buildForm() {
            const w = qs('#formWrapper')
            w.innerHTML = ''

            configFields.forEach(f => {
                const box = el('div', { class: 'card' })
                box.append(el('label', {}, f.label))

                if (f.type === 'select') {
                    const input = el('select')
                    input.append(el('option', { value: '' }, 'Select'))
                        ; (f.options || '').split(/;|,/).forEach(o => {
                            o = o.trim()
                            if (o) input.append(el('option', { value: o }, o))
                        })
                    input.onchange = () => {
                        answers[f.key] = input.value
                        autosave(f.key, input.value)
                        updateSurveyProgress()
                    }
                    box.append(input)
                }

                else if (f.type === 'text' || f.type === 'number') {
                    const input = el('input', { type: f.type })
                    input.oninput = () => {
                        answers[f.key] = input.value
                        autosave(f.key, input.value)
                        updateSurveyProgress()
                    }
                    box.append(input)
                }

                else if (f.type === 'radio') {
                    const wrap = el('div', { class: 'radio' })
                        ; (f.options || '').split(/;|,/).forEach(o => {
                            o = o.trim()
                            if (!o) return
                            const r = el('input', { type: 'radio', name: f.key, value: o })
                            r.onchange = () => {
                                answers[f.key] = o
                                autosave(f.key, o)
                                updateSurveyProgress()
                            }
                            wrap.append(el('label', {}, r, " " + o))
                        })
                    box.append(wrap)
                }

                w.append(box)
            })
        }

        qs('#submitBtn').onclick = () => {
            fetch(WEBAPP_URL, {
                method: 'POST',
                body: JSON.stringify({ sessionId, submitted: true, answers })
            })
            qs('#formWrapper').style.display = 'none'
            qs('#submitBtn').style.display = 'none'
            qs('#surveyBar').style.display = 'none'
            qs('#thanks').style.display = 'block'
        }

        loadConfigAndBuild()
    </script>

</body>

</html>
